============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pytest.ini
testpaths: tests
plugins: asyncio-1.3.0, anyio-4.12.1, cov-4.1.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 91 items

tests/e2e/test_integration_bridge.py::test_agent_registration_e2e FAILED [  1%]
tests/e2e/test_integration_bridge.py::test_mission_submission_e2e FAILED [  2%]
tests/e2e/test_integration_bridge.py::test_telemetry_aggregation_e2e PASSED [  3%]
tests/perf/test_engine_latency.py::test_engine_run_latency_distribution PASSED [  4%]
tests/perf/test_interpreter_perf.py::test_perf_simple_loop_under_threshold PASSED [  5%]
tests/unit/test_agent_registry_acceptance.py::test_duplicate_payload_returns_200 FAILED [  6%]
tests/unit/test_agent_registry_acceptance.py::test_immutable_role_change_rejected_422 FAILED [  7%]
tests/unit/test_agent_registry_acceptance.py::test_version_minor_bumps_and_patch_resets_on_dedup_re_register FAILED [  8%]
tests/unit/test_agent_registry_idempotent.py::test_sse_stream_endpoint_available PASSED [  9%]
tests/unit/test_agent_registry_idempotent.py::test_idempotent_registration_by_dedup_key FAILED [ 10%]
tests/unit/test_agent_registry_idempotent.py::test_metrics_exposed PASSED [ 12%]
tests/unit/test_agents.py::test_register_agent FAILED                    [ 13%]
tests/unit/test_agents.py::test_get_agents FAILED                        [ 14%]
tests/unit/test_agents.py::test_heartbeat FAILED                         [ 15%]
tests/unit/test_agents.py::test_sse_stream_endpoint_sync FAILED          [ 16%]
tests/unit/test_auth_config.py::test_security_validation_dev PASSED      [ 17%]
tests/unit/test_auth_config.py::test_security_validation_prod_missing PASSED [ 18%]
tests/unit/test_auth_config.py::test_security_validation_prod_short FAILED [ 19%]
tests/unit/test_auth_config.py::test_security_validation_prod_valid FAILED [ 20%]
tests/unit/test_circuit_breaker.py::test_circuit_breaker_opens_after_failures FAILED [ 21%]
tests/unit/test_collaboration_efficiency.py::test_agents_collaboration_register_list_heartbeat FAILED [ 23%]
tests/unit/test_dlq_consumer.py::test_dlq_publish_and_persist FAILED     [ 24%]
tests/unit/test_engine_adapter.py::test_adapter_api_path PASSED          [ 25%]
tests/unit/test_engine_adapter.py::test_adapter_cli_path PASSED          [ 26%]
tests/unit/test_engine_adapter_payload.py::test_adapter_forwards_env_and_target PASSED [ 27%]
tests/unit/test_engine_run_route.py::test_engine_run_route PASSED        [ 28%]
tests/unit/test_error_handling.py::test_agent_register_role_change_422 FAILED [ 29%]
tests/unit/test_error_handling.py::test_execution_error_status PASSED    [ 30%]
tests/unit/test_event_bus.py::test_publish_subscribe_roundtrip FAILED    [ 31%]
tests/unit/test_execute_hc.py::test_execute_hc_eval_print PASSED         [ 32%]
tests/unit/test_execute_hc_file.py::test_execute_hc_file_run FAILED      [ 34%]
tests/unit/test_hc_parser.py::test_parse_hc_mission_block PASSED         [ 35%]
tests/unit/test_health.py::test_health_check PASSED                      [ 36%]
tests/unit/test_heartbeat_lifecycle.py::test_heartbeat_full_lifecycle FAILED [ 37%]
tests/unit/test_heartbeat_lifecycle.py::test_timeout_marks_offline FAILED [ 38%]
tests/unit/test_hypercode_cli_target.py::test_cli_includes_target_flag PASSED [ 39%]
tests/unit/test_immutable_error_payload.py::test_immutable_role_error_payload FAILED [ 40%]
tests/unit/test_interpreter_constructs.py::test_if_else PASSED           [ 41%]
tests/unit/test_interpreter_constructs.py::test_while_loop_break PASSED  [ 42%]
tests/unit/test_interpreter_constructs.py::test_for_loop_continue PASSED [ 43%]
tests/unit/test_interpreter_constructs.py::test_function_decl_and_call PASSED [ 45%]
tests/unit/test_interpreter_constructs.py::test_scoping_variables PASSED [ 46%]
tests/unit/test_interpreter_constructs.py::test_operators_and_expressions PASSED [ 47%]
tests/unit/test_interpreter_errors.py::test_undefined_name_error PASSED  [ 48%]
tests/unit/test_interpreter_errors.py::test_unsupported_node_error PASSED [ 49%]
tests/unit/test_interpreter_metrics.py::test_interpreter_metrics_success_exposed PASSED [ 50%]
tests/unit/test_interpreter_metrics.py::test_interpreter_metrics_error_exposed PASSED [ 51%]
tests/unit/test_key_manager.py::test_generate_list_validate_revoke FAILED [ 52%]
tests/unit/test_key_manager.py::test_api_key_fallback FAILED             [ 53%]
tests/unit/test_memory_service.py::test_memory_crud_and_search FAILED    [ 54%]
tests/unit/test_memory_service.py::test_memory_cleanup_expired FAILED    [ 56%]
tests/unit/test_metrics_latency.py::test_stream_latency_metric_observed PASSED [ 57%]
tests/unit/test_mission_flow_report.py::test_mission_flow_and_report FAILED [ 58%]
tests/unit/test_mission_lifecycle.py::test_mission_full_lifecycle FAILED [ 59%]
tests/unit/test_nd_errors.py::test_undefined_name_error_with_suggestions PASSED [ 60%]
tests/unit/test_nd_errors.py::test_syntax_error_formatting PASSED        [ 61%]
tests/unit/test_nd_errors.py::test_type_error_explanation PASSED         [ 62%]
tests/unit/test_nd_errors.py::test_unsupported_feature_helpful PASSED    [ 63%]
tests/unit/test_nd_errors.py::test_similar_names_detection PASSED        [ 64%]
tests/unit/test_orchestrator_selection.py::test_orchestrator_assign_prefers_capability_and_health FAILED [ 65%]
tests/unit/test_parser.py::test_parse_hello_world PASSED                 [ 67%]
tests/unit/test_parser.py::test_parse_assignment PASSED                  [ 68%]
tests/unit/test_parser.py::test_parse_function_def PASSED                [ 69%]
tests/unit/test_rate_limit.py::test_rate_limiter_redis_allowed FAILED    [ 70%]
tests/unit/test_rate_limit.py::test_rate_limiter_redis_blocked FAILED    [ 71%]
tests/unit/test_rate_limit.py::test_rate_limiter_fallback FAILED         [ 72%]
tests/unit/test_rate_limit.py::test_check_rate_limit_dependency PASSED   [ 73%]
tests/unit/test_report_endpoint.py::test_report_endpoint_success PASSED  [ 74%]
tests/unit/test_report_endpoint.py::test_report_endpoint_error PASSED    [ 75%]
tests/unit/test_report_endpoint.py::test_report_endpoint_invalid_json PASSED [ 76%]
tests/unit/test_retry_backoff.py::test_schedule_retry_exponential_backoff_and_jitter FAILED [ 78%]
tests/unit/test_retry_backoff.py::test_max_retries_prevents_scheduling PASSED [ 79%]
tests/unit/test_retry_integration.py::test_retry_flow_schedules_and_requeues FAILED [ 80%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-architect] FAILED [ 81%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[Worker-architect] FAILED [ 82%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-Architect] FAILED [ 83%]
tests/unit/test_role_immutability.py::test_case_only_role_is_considered_same FAILED [ 84%]
tests/unit/test_services_event_bus.py::test_publish_subscribe_envelope_roundtrip FAILED [ 85%]
tests/unit/test_sse_emission.py::test_sse_emits_valid_messages PASSED    [ 86%]
tests/unit/test_sse_emission.py::test_sse_handles_malformed_data PASSED  [ 87%]
tests/unit/test_sse_emission.py::test_sse_high_frequency PASSED          [ 89%]
tests/unit/test_sse_emission.py::test_sse_connection_recovers PASSED     [ 90%]
tests/unit/test_sse_resilience.py::test_sse_handles_cancelled_error FAILED [ 91%]
tests/unit/test_sse_resilience.py::test_sse_pubsub_failure_does_not_500 FAILED [ 92%]
tests/unit/test_sse_stability.py::test_sse_stream_connects_with_backoff FAILED [ 93%]
tests/unit/test_sse_stability.py::test_metrics_endpoint_exposes_sse_metrics FAILED [ 94%]
tests/unit/test_voice_service.py::test_dc_offset_filter_reduces_offset PASSED [ 95%]
tests/unit/test_voice_service.py::test_agc_scales_signal PASSED          [ 96%]
tests/unit/test_voice_service.py::test_audio_buffer_window_and_transcribe PASSED [ 97%]
tests/unit/test_voice_ws.py::test_voice_ws_text_flow_dev_auth_disabled FAILED [ 98%]
tests/unit/test_voice_ws.py::test_voice_ws_rate_limit FAILED             [100%]

=================================== FAILURES ===================================
_________________________ test_agent_registration_e2e __________________________

    def test_agent_registration_e2e():
        payload = {
            "name": "integration-agent",
            "role": "worker",
            "version": "1.0.0",
            "capabilities": ["integration"],
            "topics": ["agent.events"],
            "health_url": "http://integration-agent:9000/health",
            "dedup_key": "integration-agent"
        }
>       r1 = client.post("/agents/register", json=payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_integration_bridge.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_________________________ test_mission_submission_e2e __________________________

self = <redis.asyncio.connection.Connection(host=redis,port=6379,db=0)>
disable_decoding = False, timeout = None

    async def read_response(
        self,
        disable_decoding: bool = False,
        timeout: Optional[float] = None,
        *,
        disconnect_on_error: bool = True,
        push_request: Optional[bool] = False,
    ):
        """Read the response from a previously sent command"""
        read_timeout = timeout if timeout is not None else self.socket_timeout
        host_error = self._host_error()
        try:
            if read_timeout is not None and self.protocol in ["3", 3]:
                async with async_timeout(read_timeout):
                    response = await self._parser.read_response(
                        disable_decoding=disable_decoding, push_request=push_request
                    )
            elif read_timeout is not None:
                async with async_timeout(read_timeout):
                    response = await self._parser.read_response(
                        disable_decoding=disable_decoding
                    )
            elif self.protocol in ["3", 3]:
                response = await self._parser.read_response(
                    disable_decoding=disable_decoding, push_request=push_request
                )
            else:
>               response = await self._parser.read_response(
                    disable_decoding=disable_decoding
                )

/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:607: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py:82: in read_response
    response = await self._read_response(disable_decoding=disable_decoding)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py:90: in _read_response
    raw = await self._readline()
          ^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:468: in _readline
    data = await self._stream.readline()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:566: in readline
    line = await self.readuntil(sep)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:658: in readuntil
    await self._wait_for_data('readuntil')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=21>>
func_name = 'readuntil'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259> cb=[TaskGroup._spawn.<locals>.task_done() at /usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:805]> got Future <Future pending> attached to a different loop

/usr/local/lib/python3.11/asyncio/streams.py:543: RuntimeError

During handling of the above exception, another exception occurred:

    def test_mission_submission_e2e():
        req = {
            "title": "Integration Mission",
            "priority": 80,
            "payload": {
                "requirements": {"capabilities": ["frontend", "backend"]},
                "plan_id": "plan-123"
            }
        }
        r = client.post("/orchestrator/mission", json=req)
        assert r.status_code == 200
        mid = r.json()["id"]
        assert mid
        # Transition to executing and completed
>       r2 = client.post(f"/orchestrator/{mid}/start")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_integration_bridge.py:45: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/orchestrator.py:35: in start
    res = await orchestrator.start(mission_id)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:362: in start
    return await self._transition(mission_id, MissionState.EXECUTING)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:295: in _transition
    v = await self.redis.hgetall(k)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:725: in execute_command
    return await conn.retry.call_with_retry(
/usr/local/lib/python3.11/site-packages/redis/asyncio/retry.py:50: in call_with_retry
    return await do()
           ^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:700: in _send_command_parse_response
    return await self.parse_response(conn, command_name, **options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:746: in parse_response
    response = await connection.read_response()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:627: in read_response
    await self.disconnect(nowait=True)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:487: in disconnect
    self._writer.close()  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:358: in close
    return self._transport.close()
           ^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/selector_events.py:864: in close
    self._loop.call_soon(self._call_connection_lost, None)
/usr/local/lib/python3.11/asyncio/base_events.py:762: in call_soon
    self._check_closed()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=True debug=False>

    def _check_closed(self):
        if self._closed:
>           raise RuntimeError('Event loop is closed')
E           RuntimeError: Event loop is closed

/usr/local/lib/python3.11/asyncio/base_events.py:520: RuntimeError
----------------------------- Captured stdout call -----------------------------
[2m2026-02-06T19:59:17.173365Z[0m [[31m[1merror    [0m] [1mPersistence failed for mission ddcaefef-8587-4b36-a3f4-b5806e0967cf: Client is not connected to the query engine, you must call `connect()` before attempting to query data.[0m
HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
______________________ test_duplicate_payload_returns_200 ______________________

    def test_duplicate_payload_returns_200():
        client = TestClient(app)
        payload = {
            "name": "Agent A",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5001/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000AA",
        }
>       r1 = client.post("/agents/register", json=payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:17: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
___________________ test_immutable_role_change_rejected_422 ____________________

    def test_immutable_role_change_rejected_422():
        client = TestClient(app)
        base = {
            "name": "Agent B",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5002/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000BB",
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
________ test_version_minor_bumps_and_patch_resets_on_dedup_re_register ________

    def test_version_minor_bumps_and_patch_resets_on_dedup_re_register():
        client = TestClient(app)
        data = {
            "name": "Agent C",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5003/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000CC",
        }
>       r1 = client.post("/agents/register", json=data)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:53: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
__________________ test_idempotent_registration_by_dedup_key ___________________

async_client = <httpx.AsyncClient object at 0x719431e8df90>

    @pytest.mark.asyncio
    async def test_idempotent_registration_by_dedup_key(async_client):
        payload1 = {
            "name": "Idem Agent",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5001/health",
            "dedup_key": "00000000-0000-0000-0000-000000000001",
        }
>       r1 = await async_client.post("/agents/register", json=payload1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_idempotent.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_____________________________ test_register_agent ______________________________

async_client = <httpx.AsyncClient object at 0x719438a2d050>

    @pytest.mark.asyncio
    async def test_register_agent(async_client):
        payload = {
            "name": "Test Agent",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5000/health",
            "dedup_key": "00000000-0000-0000-0000-00000000TA"
        }
>       response = await async_client.post("/agents/register", json=payload)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agents.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_______________________________ test_get_agents ________________________________

async_client = <httpx.AsyncClient object at 0x7194335d21d0>

    @pytest.mark.asyncio
    async def test_get_agents(async_client):
        # Register an agent first
>       await test_register_agent(async_client)

tests/unit/test_agents.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/test_agents.py:18: in test_register_agent
    response = await async_client.post("/agents/register", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
________________________________ test_heartbeat ________________________________

async_client = <httpx.AsyncClient object at 0x71943331b910>

    @pytest.mark.asyncio
    async def test_heartbeat(async_client):
        # Register
>       agent_id = await test_register_agent(async_client)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agents.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/test_agents.py:18: in test_register_agent
    response = await async_client.post("/agents/register", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
________________________ test_sse_stream_endpoint_sync _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_agents.py", line 57, in test_sse_stream_endpoint_sync
  |     resp = client.get("/agents/watch?one_shot=true")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x719438985090 [unset]> is bound to a different event loop
    +------------------------------------
_____________________ test_security_validation_prod_short ______________________

    def test_security_validation_prod_short():
        # Production short secret should fail
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET="short", HYPERCODE_DB_URL="sqlite://")
        with pytest.raises(ValueError, match="too short"):
>           s.validate_security()

tests/unit/test_auth_config.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='HyperCode Core', ENVIRONMENT='production', OPENAI_API_KEY='sk-placeholder-key', HYPERCODE_DB_URL='s...t:6379/0', CELERY_RESULT_BACKEND='redis://localhost:6379/0', RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_MAX_REQUESTS=100)

    def validate_security(self):
        # Allow dev/test bypass
        if self.ENVIRONMENT.lower() in ("development", "test"):
            return
    
        if not self.API_KEY:
>           raise ValueError("API_KEY is missing in production/staging!")
E           ValueError: API_KEY is missing in production/staging!

app/core/config.py:25: ValueError

During handling of the above exception, another exception occurred:

    def test_security_validation_prod_short():
        # Production short secret should fail
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET="short", HYPERCODE_DB_URL="sqlite://")
>       with pytest.raises(ValueError, match="too short"):
E       AssertionError: Regex pattern did not match.
E         Expected regex: 'too short'
E         Actual message: 'API_KEY is missing in production/staging!'

tests/unit/test_auth_config.py:19: AssertionError
_____________________ test_security_validation_prod_valid ______________________

    def test_security_validation_prod_valid():
        # Production valid secret should pass
        valid_secret = "a" * 32
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET=valid_secret, HYPERCODE_DB_URL="sqlite://")
>       s.validate_security() # Should not raise
        ^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_auth_config.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='HyperCode Core', ENVIRONMENT='production', OPENAI_API_KEY='sk-placeholder-key', HYPERCODE_DB_URL='s...t:6379/0', CELERY_RESULT_BACKEND='redis://localhost:6379/0', RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_MAX_REQUESTS=100)

    def validate_security(self):
        # Allow dev/test bypass
        if self.ENVIRONMENT.lower() in ("development", "test"):
            return
    
        if not self.API_KEY:
>           raise ValueError("API_KEY is missing in production/staging!")
E           ValueError: API_KEY is missing in production/staging!

app/core/config.py:25: ValueError
__________________ test_circuit_breaker_opens_after_failures ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7194335d0a90>

    @pytest.mark.asyncio
    async def test_circuit_breaker_opens_after_failures(monkeypatch):
        try:
            from fakeredis.aioredis import FakeRedis
            orchestrator.redis = FakeRedis()
        except Exception:
            pytest.skip("fakeredis not available")
    
        mid = "mission-fail-1"
        key = await orchestrator._key(mid)
>       await orchestrator.redis.hset(key, mapping={
            "id": mid,
            "title": "Breaker Mission",
            "state": MissionState.ASSIGNED.value,
            "priority": 50,
            "agent_id": "agent-123",
            "created_at": "2024-01-01T00:00:00",
            "updated_at": "2024-01-01T00:00:00",
        })

tests/unit/test_circuit_breaker.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719438251fd0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
______________ test_agents_collaboration_register_list_heartbeat _______________

    def test_agents_collaboration_register_list_heartbeat():
        client = TestClient(app)
        a1 = {
            "name": "Crew Worker 1",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5002/health",
            "dedup_key": "00000000-0000-0000-0000-00000000W1",
        }
        a2 = {
            "name": "Crew Worker 2",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5003/health",
            "dedup_key": "00000000-0000-0000-0000-00000000W2",
        }
>       r1 = client.post("/agents/register", json=a1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_collaboration_efficiency.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_________________________ test_dlq_publish_and_persist _________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x71943214cb10>

    @pytest.mark.asyncio
    async def test_dlq_publish_and_persist(monkeypatch):
        try:
            from fakeredis.aioredis import FakeRedis
            event_bus.redis = FakeRedis()
        except Exception:
            pytest.skip("fakeredis not available")
    
        await event_bus.ensure_consumer_group("mission.dlq", "mission-dlq")
        env = MessageEnvelope(sender_id="core", message_type="mission.retry.exhausted", payload={"mission_id": "mid-1"})
>       entry_id = await event_bus.publish_stream("mission.dlq", env)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_dlq_consumer.py:17: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/event_bus.py:89: in publish_stream
    entry_id = await self.redis.xadd(stream, fields)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719433354f50>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
----------------------------- Captured stdout call -----------------------------
Failed to publish stream mission.dlq: 'FakeReader' object has no attribute 'at_eof'
------------------------------ Captured log call -------------------------------
ERROR    app.services.event_bus:event_bus.py:92 Failed to publish stream mission.dlq: 'FakeReader' object has no attribute 'at_eof'
_____________________ test_agent_register_role_change_422 ______________________

    def test_agent_register_role_change_422():
        client = TestClient(app)
        base = {
            "name": "Crew A",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5001/health",
            "dedup_key": "00000000-0000-0000-0000-00000000RC",
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_error_handling.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_______________________ test_publish_subscribe_roundtrip _______________________

    @pytest.mark.asyncio
    async def test_publish_subscribe_roundtrip():
        channel = "test:events"
        msg = {"hello": "world"}
        async def collect():
            gen = event_bus.subscribe(channel)
            async for m in gen:
                return m
        t = asyncio.create_task(collect())
        await asyncio.sleep(0.05)
>       await event_bus.publish(channel, msg)

tests/unit/test_event_bus.py:27: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/core/event_bus.py:22: in publish
    await self.redis.publish(channel, json.dumps(message))
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x7194334738d0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
___________________________ test_execute_hc_file_run ___________________________

    def test_execute_hc_file_run():
        client = TestClient(app)
        with tempfile.NamedTemporaryFile("w", delete=False, suffix=".hc", encoding="utf-8") as tf:
            tf.write('print "From File"')
            temp_path = tf.name
        try:
            resp = client.post("/execution/execute-hc-file", json={"path": temp_path})
>           assert resp.status_code == 200
E           assert 400 == 200
E            +  where 400 = <Response [400 Bad Request]>.status_code

tests/unit/test_execute_hc_file.py:13: AssertionError
----------------------------- Captured stdout call -----------------------------
HTTP Request: POST http://testserver/execution/execute-hc-file "HTTP/1.1 400 Bad Request"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/execution/execute-hc-file "HTTP/1.1 400 Bad Request"
________________________ test_heartbeat_full_lifecycle _________________________

async_client = <httpx.AsyncClient object at 0x7194385b8110>

    @pytest.mark.asyncio
    async def test_heartbeat_full_lifecycle(async_client):
        payload = {
            "name": "Lifecycle Agent",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c"],
            "topics": ["t"],
            "health_url": "http://localhost",
            "dedup_key": "00000000-0000-0000-0000-00000000LC"
        }
>       r = await async_client.post("/agents/register", json=payload)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_heartbeat_lifecycle.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
--------------------------- Captured stdout teardown ---------------------------
Task exception was never retrieved
future: <Task finished name='Task-432' coro=<test_publish_subscribe_roundtrip.<locals>.collect() done, defined at /app/tests/unit/test_event_bus.py:21> exception=AttributeError("'FakeReader' object has no attribute 'at_eof'")>
Traceback (most recent call last):
  File "/app/tests/unit/test_event_bus.py", line 23, in collect
    async for m in gen:
  File "/app/app/core/event_bus.py", line 28, in subscribe
    await pubsub.subscribe(channel)
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 1119, in subscribe
    ret_val = await self.execute_command("SUBSCRIBE", *new_channels.keys())
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 972, in execute_command
    await self.connect()
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 982, in connect
    self.connection = await self.connection_pool.get_connection()
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 1198, in get_connection
    await self.ensure_connection(connection)
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 1237, in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 574, in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py", line 434, in can_read_destructive
    return self._stream.at_eof()
           ^^^^^^^^^^^^^^^^^^^
AttributeError: 'FakeReader' object has no attribute 'at_eof'
__________________________ test_timeout_marks_offline __________________________

async_client = <httpx.AsyncClient object at 0x719433595790>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x71943203b250>

    @pytest.mark.asyncio
    async def test_timeout_marks_offline(async_client, monkeypatch):
        payload = {
            "name": "Timeout Agent",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000TO"
        }
>       r = await async_client.post("/agents/register", json=payload)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_heartbeat_lifecycle.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
______________________ test_immutable_role_error_payload _______________________

    def test_immutable_role_error_payload():
        client = TestClient(app)
        base = {
            "name": "Immut",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000IM"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_immutable_error_payload.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
______________________ test_generate_list_validate_revoke ______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7194389213d0>

    @pytest.mark.asyncio
    async def test_generate_list_validate_revoke(monkeypatch):
>       k = await key_manager.generate_key(label="test")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_key_manager.py:19: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/key_manager.py:47: in generate_key
    await pipe.execute()
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:1647: in execute
    conn = await self.connection_pool.get_connection()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719433357f50>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
____________________________ test_api_key_fallback _____________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7194333da4d0>

    @pytest.mark.asyncio
    async def test_api_key_fallback(monkeypatch):
        monkeypatch.setenv("API_KEY", "static_key")
        from app.core.config import get_settings
        s = get_settings()
        s.API_KEY = "static_key"
>       ok = await key_manager.is_valid("static_key")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_key_manager.py:35: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/key_manager.py:73: in is_valid
    is_active = await self.redis.sismember(self.active_keys_set, key)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x71943a05c450>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
_________________________ test_memory_crud_and_search __________________________

    @pytest.mark.asyncio
    async def test_memory_crud_and_search():
        create = MemoryCreate(
            content="Hello world",
            type="short-term",
            userId="u1",
            sessionId="s1",
            metadata={"a": 1},
            keywords=["hello", "greeting"],
            missionId="m1",
            expiresAt=None,
        )
>       m = await MemoryService.create_memory(create)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_memory_service.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/memory_service.py:86: in create_memory
    memory = await db.memory.create(
/usr/local/lib/python3.11/site-packages/prisma/actions.py:2235: in create
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
[2m2026-02-06T20:00:27.769328Z[0m [[32m[1minfo     [0m] [1mcreating_memory               [0m [36mtype[0m=[35mshort-term[0m [36muser_id[0m=[35mu1[0m
_________________________ test_memory_cleanup_expired __________________________

    @pytest.mark.asyncio
    async def test_memory_cleanup_expired():
        expire_time = datetime.now(timezone.utc) + timedelta(seconds=0.1)
>       m = await MemoryService.create_memory(MemoryCreate(
            content="To expire",
            type="short-term",
            userId="u2",
            sessionId="s2",
            keywords=["expire"],
            missionId=None,
            expiresAt=expire_time
        ))

tests/unit/test_memory_service.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/memory_service.py:86: in create_memory
    memory = await db.memory.create(
/usr/local/lib/python3.11/site-packages/prisma/actions.py:2235: in create
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
[2m2026-02-06T20:00:28.261456Z[0m [[32m[1minfo     [0m] [1mcreating_memory               [0m [36mtype[0m=[35mshort-term[0m [36muser_id[0m=[35mu2[0m
_________________________ test_mission_flow_and_report _________________________

async_client = <httpx.AsyncClient object at 0x71943898af90>

    @pytest.mark.asyncio
    async def test_mission_flow_and_report(async_client: AsyncClient):
>       create = await async_client.post(
            "/orchestrator/mission",
            json={"title": "Demo", "priority": 10, "payload": {"requirements": {"capabilities": ["backend"]}}},
        )

tests/unit/test_mission_flow_report.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/orchestrator.py:24: in submit_mission
    return await orchestrator.submit(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:75: in submit
    await self.redis.hset(await self._key(mid), mapping=data)
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719438251fd0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
_________________________ test_mission_full_lifecycle __________________________

    @pytest.mark.asyncio
    async def test_mission_full_lifecycle():
        # Mock EventBus
        with patch.object(event_bus, "publish_stream", new_callable=AsyncMock) as mock_publish:
            mock_publish.return_value = "1-0" # Mock entry ID
    
            # 1. Submit
            req = {"title": "Lifecycle Mission", "priority": 80, "payload": {"foo": "bar"}}
>           r = client.post("/orchestrator/mission", json=req)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_mission_lifecycle.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/orchestrator.py:24: in submit_mission
    return await orchestrator.submit(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:75: in submit
    await self.redis.hset(await self._key(mid), mapping=data)
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719438251fd0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
____________ test_orchestrator_assign_prefers_capability_and_health ____________

    def test_orchestrator_assign_prefers_capability_and_health():
        # Override auth to allow access
        app.dependency_overrides[get_current_user] = lambda: {
            "sub": "test-user",
            "scopes": ["mission:write", "mission:read", "mission:assign"]
        }
        client = TestClient(app)
        # Register two agents: one with gpu capability, one without
        a1 = {
            "name": "Worker NoGPU",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5004/health",
            "dedup_key": "00000000-0000-0000-0000-00000000NG",
        }
        a2 = {
            "name": "Worker GPU",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute", "gpu"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5005/health",
            "dedup_key": "00000000-0000-0000-0000-00000000GP",
        }
>       r1 = client.post("/agents/register", json=a1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_orchestrator_selection.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
_______________________ test_rate_limiter_redis_allowed ________________________

self = <app.middleware.rate_limit.RateLimiter object at 0x719431e15d10>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
>               RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                ^^^^^^^^^^^^^^^^^
E               NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:55: NameError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_rate_limiter_redis_allowed():
        limiter = RateLimiter()
        limiter._redis = AsyncMock()
        limiter._script = AsyncMock(return_value=1) # Lua returns 1 for allowed
    
>       allowed = await limiter.check("test_key", 10, 60)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x719431e15d10>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
                RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                if not allowed:
                    RATE_LIMIT_HITS.labels(scope=scope).inc()
                return allowed
            except Exception as e:
                logger.error(f"Redis rate limit error: {e}")
>               REDIS_ERRORS.inc()
                ^^^^^^^^^^^^
E               NameError: name 'REDIS_ERRORS' is not defined

app/middleware/rate_limit.py:61: NameError
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
_______________________ test_rate_limiter_redis_blocked ________________________

self = <app.middleware.rate_limit.RateLimiter object at 0x719433f7c9d0>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
>               RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                ^^^^^^^^^^^^^^^^^
E               NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:55: NameError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_rate_limiter_redis_blocked():
        limiter = RateLimiter()
        limiter._redis = AsyncMock()
        limiter._script = AsyncMock(return_value=0) # Lua returns 0 for blocked
    
>       allowed = await limiter.check("test_key", 10, 60)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x719433f7c9d0>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
                RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                if not allowed:
                    RATE_LIMIT_HITS.labels(scope=scope).inc()
                return allowed
            except Exception as e:
                logger.error(f"Redis rate limit error: {e}")
>               REDIS_ERRORS.inc()
                ^^^^^^^^^^^^
E               NameError: name 'REDIS_ERRORS' is not defined

app/middleware/rate_limit.py:61: NameError
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
__________________________ test_rate_limiter_fallback __________________________

    @pytest.mark.asyncio
    async def test_rate_limiter_fallback():
        limiter = RateLimiter()
        limiter._redis = None # Simulate no redis
    
        # Should use in-memory fallback
        # Limit 2
        key = "test_fallback"
>       assert await limiter.check(key, 2, 60) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/middleware/rate_limit.py:65: in check
    return self._check_fallback(key, limit, window, scope)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x719438890290>
key = 'test_fallback', limit = 2, window = 60, scope = 'general'

    def _check_fallback(self, key: str, limit: int, window: int, scope: str = "general") -> bool:
        now = int(time.time())
        # Simple fixed window based on time bucket
        bucket = now // window
        full_key = f"{key}:{bucket}"
    
        count = self._fallback_counters.get(full_key, 0)
        if count >= limit:
            RATE_LIMIT_CHECKS.labels(scope=scope, status="blocked").inc()
            RATE_LIMIT_HITS.labels(scope=scope).inc()
            return False
    
        self._fallback_counters[full_key] = count + 1
>       RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed").inc()
        ^^^^^^^^^^^^^^^^^
E       NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:80: NameError
______________ test_schedule_retry_exponential_backoff_and_jitter ______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x719431e155d0>

    @pytest.mark.asyncio
    async def test_schedule_retry_exponential_backoff_and_jitter(monkeypatch):
        try:
            from fakeredis.aioredis import FakeRedis
            event_bus.redis = FakeRedis()
        except Exception:
            pytest.skip("fakeredis not available")
    
        mid = "mission-backoff-1"
        with patch("random.uniform", return_value=0.5):
            ok, delay1 = await event_bus.schedule_retry(mid, 1, base=2.0, factor=2.0, jitter=0.5, max_delay=300.0)
>           assert ok
E           assert False

tests/unit/test_retry_backoff.py:18: AssertionError
____________________ test_retry_flow_schedules_and_requeues ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x71943865c490>

    @pytest.mark.asyncio
    async def test_retry_flow_schedules_and_requeues(monkeypatch):
        try:
            from fakeredis.aioredis import FakeRedis
            event_bus.redis = FakeRedis()
            orchestrator.redis = event_bus.redis
        except Exception:
            pytest.skip("fakeredis not available")
    
        mid = "mission-int-1"
        key = await orchestrator._key(mid)
>       await orchestrator.redis.hset(key, mapping={
            "id": mid,
            "title": "Integration Mission",
            "state": MissionState.FAILED.value,
            "priority": 50,
            "agent_id": "agent-x",
            "created_at": "2024-01-01T00:00:00",
            "updated_at": "2024-01-01T00:00:00",
        })

tests/unit/test_retry_integration.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x719431eb15d0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
______ test_role_change_with_same_dedup_key_returns_422[worker-architect] ______

initial_role = 'worker', changed_role = 'architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
______ test_role_change_with_same_dedup_key_returns_422[Worker-architect] ______

initial_role = 'Worker', changed_role = 'architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
______ test_role_change_with_same_dedup_key_returns_422[worker-Architect] ______

initial_role = 'worker', changed_role = 'Architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
____________________ test_case_only_role_is_considered_same ____________________

    def test_case_only_role_is_considered_same():
        client = TestClient(app)
        base = {
            "name": "RoleCase",
            "role": "Worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RC"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
__________________ test_publish_subscribe_envelope_roundtrip ___________________

    @pytest.mark.asyncio
    async def test_publish_subscribe_envelope_roundtrip():
        channel = "system.events"
        env = MessageEnvelope(sender_id="a", message_type="system_event", payload={"x": 1})
        async def collect():
            gen = event_bus.subscribe(channel, role="general")
            async for m in gen:
                return m
        t = asyncio.create_task(collect())
        await asyncio.sleep(0.05)
>       ok = await event_bus.publish(channel, env, role="general")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_services_event_bus.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/event_bus.py:70: in publish
    await self.redis.publish(channel, data)
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:1237: in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:574: in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x7194389fc6d0>

    async def can_read_destructive(self) -> bool:
        if not self._connected:
            raise RedisError("Buffer is closed.")
        if self._buffer:
            return True
        try:
            async with async_timeout(0):
>               return self._stream.at_eof()
                       ^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'FakeReader' object has no attribute 'at_eof'

/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:434: AttributeError
----------------------------- Captured stdout call -----------------------------
Failed to publish message to system.events: 'FakeReader' object has no attribute 'at_eof'
------------------------------ Captured log call -------------------------------
ERROR    app.services.event_bus:event_bus.py:74 Failed to publish message to system.events: 'FakeReader' object has no attribute 'at_eof'
_______________________ test_sse_handles_cancelled_error _______________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_sse_resilience.py", line 24, in test_sse_handles_cancelled_error
  |     resp = client.get("/agents/stream")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x719438985090 [unset]> is bound to a different event loop
    +------------------------------------
_____________________ test_sse_pubsub_failure_does_not_500 _____________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_sse_resilience.py", line 48, in test_sse_pubsub_failure_does_not_500
  |     resp = client.get("/agents/watch")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x719438985090 [unset]> is bound to a different event loop
    +------------------------------------
____________________ test_sse_stream_connects_with_backoff _____________________

async_client = <httpx.AsyncClient object at 0x7194320ce550>

    @pytest.mark.asyncio
    async def test_sse_stream_connects_with_backoff(async_client):
        connected = False
        for delay in _backoff_delays():
            try:
                async with async_client.stream("GET", "/agents/watch?one_shot=true", timeout=Timeout(2.0)) as resp:
                    if resp.status_code == 200:
                        connected = True
                        break
            except Exception:
                await asyncio.sleep(delay)
>       assert connected
E       assert False

tests/unit/test_sse_stability.py:23: AssertionError
__________________ test_metrics_endpoint_exposes_sse_metrics ___________________

async_client = <httpx.AsyncClient object at 0x7194321f9090>

    @pytest.mark.asyncio
    async def test_metrics_endpoint_exposes_sse_metrics(async_client):
        payload = {
            "name": "SSE Metrics Agent",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000SM"
        }
>       r = await async_client.post("/agents/register", json=payload)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_sse_stability.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
                 ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <prisma.client.Prisma object at 0x71943cafe330>

    @property
    def _engine(self) -> _EngineT:
        engine = self._internal_engine
        if engine is None:
>           raise ClientNotConnectedError()
E           prisma.errors.ClientNotConnectedError: Client is not connected to the query engine, you must call `connect()` before attempting to query data.

/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:199: ClientNotConnectedError
----------------------------- Captured stdout call -----------------------------
Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
------------------------------ Captured log call -------------------------------
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: Client is not connected to the query engine, you must call `connect()` before attempting to query data.
--------------------------- Captured stdout teardown ---------------------------
Task exception was never retrieved
future: <Task finished name='Task-851' coro=<test_publish_subscribe_envelope_roundtrip.<locals>.collect() done, defined at /app/tests/unit/test_services_event_bus.py:22> exception=AttributeError("'FakeReader' object has no attribute 'at_eof'")>
Traceback (most recent call last):
  File "/app/tests/unit/test_services_event_bus.py", line 24, in collect
    async for m in gen:
  File "/app/app/services/event_bus.py", line 161, in subscribe
    await pubsub.subscribe(channel)
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 1119, in subscribe
    ret_val = await self.execute_command("SUBSCRIBE", *new_channels.keys())
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 972, in execute_command
    await self.connect()
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py", line 982, in connect
    self.connection = await self.connection_pool.get_connection()
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 1198, in get_connection
    await self.ensure_connection(connection)
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 1237, in ensure_connection
    if await connection.can_read_destructive():
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py", line 574, in can_read_destructive
    return await self._parser.can_read_destructive()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py", line 434, in can_read_destructive
    return self._stream.at_eof()
           ^^^^^^^^^^^^^^^^^^^
AttributeError: 'FakeReader' object has no attribute 'at_eof'
__________________ test_voice_ws_text_flow_dev_auth_disabled ___________________

    def test_voice_ws_text_flow_dev_auth_disabled():
        settings = get_settings()
        # ensure dev mode allows open access
        assert settings.API_KEY in (None, "",)
        with client.websocket_connect("/voice/ws") as ws:
            ws.send_text(json.dumps({"text": "print('hi')"}))
>           data = ws.receive_json()
                   ^^^^^^^^^^^^^^^^^

tests/unit/test_voice_ws.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:191: in receive_json
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.testclient.WebSocketTestSession object at 0x7194320c0790>
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.11/site-packages/starlette/testclient.py:144: WebSocketDisconnect
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
[2m2026-02-06T20:01:07.197132Z[0m [[31m[1merror    [0m] [1mvoice_ws_error                [0m [36merror[0m=[35mname 'REDIS_ERRORS' is not defined[0m
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
___________________________ test_voice_ws_rate_limit ___________________________

    def test_voice_ws_rate_limit():
        # simulate many messages and expect success under limit
        with client.websocket_connect("/voice/ws") as ws:
            for _ in range(5):
                ws.send_text(json.dumps({"text": "print('x')"}))
>               data = ws.receive_json()
                       ^^^^^^^^^^^^^^^^^

tests/unit/test_voice_ws.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:191: in receive_json
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.testclient.WebSocketTestSession object at 0x719438649890>
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.11/site-packages/starlette/testclient.py:144: WebSocketDisconnect
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: Event loop is closed
[2m2026-02-06T20:01:07.458287Z[0m [[31m[1merror    [0m] [1mvoice_ws_error                [0m [36merror[0m=[35mname 'REDIS_ERRORS' is not defined[0m
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: Event loop is closed
=============================== warnings summary ===============================
app/core/config.py:5
  /app/app/core/config.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

app/schemas/agent.py:17
  /app/app/schemas/agent.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AgentMetadata(BaseModel):

app/schemas/memory.py:24
  /app/app/schemas/memory.py:24: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class MemoryResponse(MemoryBase):

tests/e2e/test_integration_bridge.py: 3 warnings
tests/perf/test_engine_latency.py: 1 warning
tests/perf/test_interpreter_perf.py: 1 warning
tests/unit/test_agent_registry_acceptance.py: 3 warnings
tests/unit/test_agent_registry_idempotent.py: 3 warnings
tests/unit/test_agents.py: 4 warnings
tests/unit/test_auth_config.py: 4 warnings
tests/unit/test_circuit_breaker.py: 2 warnings
tests/unit/test_collaboration_efficiency.py: 1 warning
tests/unit/test_dlq_consumer.py: 2 warnings
tests/unit/test_engine_adapter.py: 2 warnings
tests/unit/test_engine_adapter_payload.py: 1 warning
tests/unit/test_engine_run_route.py: 1 warning
tests/unit/test_error_handling.py: 2 warnings
tests/unit/test_event_bus.py: 2 warnings
tests/unit/test_execute_hc.py: 1 warning
tests/unit/test_execute_hc_file.py: 1 warning
tests/unit/test_hc_parser.py: 1 warning
tests/unit/test_health.py: 1 warning
tests/unit/test_heartbeat_lifecycle.py: 2 warnings
tests/unit/test_hypercode_cli_target.py: 1 warning
tests/unit/test_immutable_error_payload.py: 1 warning
tests/unit/test_interpreter_constructs.py: 6 warnings
tests/unit/test_interpreter_errors.py: 2 warnings
tests/unit/test_interpreter_metrics.py: 2 warnings
tests/unit/test_key_manager.py: 4 warnings
tests/unit/test_memory_service.py: 2 warnings
tests/unit/test_metrics_latency.py: 1 warning
tests/unit/test_mission_flow_report.py: 1 warning
tests/unit/test_mission_lifecycle.py: 1 warning
tests/unit/test_nd_errors.py: 5 warnings
tests/unit/test_orchestrator_selection.py: 1 warning
tests/unit/test_parser.py: 3 warnings
tests/unit/test_rate_limit.py: 4 warnings
tests/unit/test_report_endpoint.py: 3 warnings
tests/unit/test_retry_backoff.py: 4 warnings
tests/unit/test_retry_integration.py: 2 warnings
tests/unit/test_role_immutability.py: 4 warnings
tests/unit/test_services_event_bus.py: 2 warnings
tests/unit/test_sse_emission.py: 4 warnings
tests/unit/test_sse_resilience.py: 2 warnings
tests/unit/test_sse_stability.py: 2 warnings
tests/unit/test_voice_service.py: 3 warnings
tests/unit/test_voice_ws.py: 2 warnings
  /usr/local/lib/python3.11/site-packages/fakeredis/aioredis.py:220: DeprecationWarning: Call to '__init__' function with deprecated usage of input argument/s 'retry_on_timeout'. (TimeoutError is included by default.) -- Deprecated since version 6.0.0.
    super().__init__(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.11.14-final-0 ----------
Name                                Stmts   Miss Branch BrPart  Cover   Missing
-------------------------------------------------------------------------------
app/core/auth.py                       39     28     20      0    19%   15-35, 48-92
app/core/config.py                     39      6     10      2    76%   27-31, 45->50, 48-49
app/core/db.py                        254    250    144      0     1%   6-298
app/core/event_bus.py                  22      5      4      0    65%   23, 29-32
app/core/logging.py                    12      1      2      1    86%   21
app/engine/adapter.py                  57     11      8      0    83%   48-51, 65-69, 71-72
app/engine/cli.py                      35      7      8      3    72%   9, 24-25, 31-34, 38->exit
app/engine/interpreter.py             231     52    156     22    73%   70, 76-77, 109->107, 125, 133-134, 136, 142, 143->145, 149, 153, 159-169, 179, 189-190, 196, 212-217, 222, 225-227, 238, 241-248, 256, 265, 268-274
app/errors/nd_errors.py                82      4     40      8    90%   30->33, 34, 35->37, 50, 104->exit, 149->152, 153, 155
app/middleware/rate_limit.py           58     13     12      1    74%   35-37, 56-58, 63, 75-77, 83-86
app/parser/__init__.py                  1      0      0      0   100%
app/parser/hc_parser.py               314     26    160     19    88%   69-71, 101-102, 123->125, 146->148, 153, 161->159, 168, 179-180, 189->187, 233->238, 243, 249, 301-307, 316, 322-324, 333, 335, 339, 363
app/routers/agents.py                 120     54     44      4    56%   27-28, 31->21, 32->31, 42-53, 55-56, 68, 73, 77-84, 88-89, 103-108, 112-124, 128-131, 135-142
app/routers/engine.py                  24      2      4      1    89%   21-22
app/routers/execution.py               39      8     16      1    76%   19, 45-46, 49-50, 54-56
app/routers/memory.py                  34     17     18      0    56%   10, 21-29, 33-36, 40-43, 47-50, 54-55
app/routers/metrics.py                 81     35     26      0    54%   17-28, 41-55, 88-97, 115-116
app/routers/orchestrator.py            83     42     50      0    53%   12, 17-20, 28-31, 36-38, 50-53, 57-60, 64-67, 71-72, 76-79, 83-86, 90-93, 97-100
app/routers/simulator.py               44     28     14      0    38%   15-30, 35, 40-51, 56-64
app/routers/voice.py                   83     51     20      2    35%   35, 43-107, 109, 115-116
app/schemas/agent.py                   38      0      4      2    95%   26->exit, 27->exit
app/schemas/execution.py               21      0      0      0   100%
app/schemas/memory.py                  32      0      0      0   100%
app/schemas/message.py                 12      0      4      0   100%
app/schemas/mission.py                 26      0      0      0   100%
app/services/__init__.py                0      0      0      0   100%
app/services/agent_registry.py        155    104     32      1    28%   78-155, 165-193, 198-209, 213-216, 220-235, 238-242, 245-253, 256-261, 264-281
app/services/event_bus.py             127     58     34      6    49%   31-34, 45-51, 59-61, 71-72, 83-84, 103-108, 111-114, 122->124, 126, 135-140, 145-149, 157-158, 162-185
app/services/execution_service.py      78     24     22      6    70%   37-43, 66-79, 98, 104, 105->107, 108, 111->113, 115
app/services/key_manager.py            71     37     16      1    40%   49-50, 54-66, 74-87, 91-102
app/services/llm.py                    35     35      2      0     0%   2-77
app/services/llm_service.py            54     37     16      0    24%   27-41, 45-64, 68, 72-95
app/services/memory_service.py        156    107     54      2    34%   13-18, 34, 37-39, 48-50, 54-67, 89-95, 99-108, 112-145, 149-158, 162-195, 199-211
app/services/metrics_registry.py       37      4     14      1    82%   23-24, 29->32, 35-36
app/services/orchestrator.py          276    187     57      0    29%   50-55, 88, 109-110, 124-290, 296-351, 365, 368, 371, 374-379, 390-411, 414-440, 443-464, 503, 508-510
app/services/voice_service.py         110     38     38      3    64%   53, 65, 80, 95-109, 114, 132-133, 135-139, 143-151, 155-160
main.py                               260    190     58      3    26%   7-9, 38-42, 51-52, 70->75, 76-77, 87-296, 306-311, 330-356
-------------------------------------------------------------------------------
TOTAL                                3140   1461   1107     89    51%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/e2e/test_integration_bridge.py::test_agent_registration_e2e - pr...
FAILED tests/e2e/test_integration_bridge.py::test_mission_submission_e2e - Ru...
FAILED tests/unit/test_agent_registry_acceptance.py::test_duplicate_payload_returns_200
FAILED tests/unit/test_agent_registry_acceptance.py::test_immutable_role_change_rejected_422
FAILED tests/unit/test_agent_registry_acceptance.py::test_version_minor_bumps_and_patch_resets_on_dedup_re_register
FAILED tests/unit/test_agent_registry_idempotent.py::test_idempotent_registration_by_dedup_key
FAILED tests/unit/test_agents.py::test_register_agent - prisma.errors.ClientN...
FAILED tests/unit/test_agents.py::test_get_agents - prisma.errors.ClientNotCo...
FAILED tests/unit/test_agents.py::test_heartbeat - prisma.errors.ClientNotCon...
FAILED tests/unit/test_agents.py::test_sse_stream_endpoint_sync - RuntimeErro...
FAILED tests/unit/test_auth_config.py::test_security_validation_prod_short - ...
FAILED tests/unit/test_auth_config.py::test_security_validation_prod_valid - ...
FAILED tests/unit/test_circuit_breaker.py::test_circuit_breaker_opens_after_failures
FAILED tests/unit/test_collaboration_efficiency.py::test_agents_collaboration_register_list_heartbeat
FAILED tests/unit/test_dlq_consumer.py::test_dlq_publish_and_persist - Attrib...
FAILED tests/unit/test_error_handling.py::test_agent_register_role_change_422
FAILED tests/unit/test_event_bus.py::test_publish_subscribe_roundtrip - Attri...
FAILED tests/unit/test_execute_hc_file.py::test_execute_hc_file_run - assert ...
FAILED tests/unit/test_heartbeat_lifecycle.py::test_heartbeat_full_lifecycle
FAILED tests/unit/test_heartbeat_lifecycle.py::test_timeout_marks_offline - p...
FAILED tests/unit/test_immutable_error_payload.py::test_immutable_role_error_payload
FAILED tests/unit/test_key_manager.py::test_generate_list_validate_revoke - A...
FAILED tests/unit/test_key_manager.py::test_api_key_fallback - AttributeError...
FAILED tests/unit/test_memory_service.py::test_memory_crud_and_search - prism...
FAILED tests/unit/test_memory_service.py::test_memory_cleanup_expired - prism...
FAILED tests/unit/test_mission_flow_report.py::test_mission_flow_and_report
FAILED tests/unit/test_mission_lifecycle.py::test_mission_full_lifecycle - At...
FAILED tests/unit/test_orchestrator_selection.py::test_orchestrator_assign_prefers_capability_and_health
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_redis_allowed - NameE...
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_redis_blocked - NameE...
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_fallback - NameError:...
FAILED tests/unit/test_retry_backoff.py::test_schedule_retry_exponential_backoff_and_jitter
FAILED tests/unit/test_retry_integration.py::test_retry_flow_schedules_and_requeues
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-architect]
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[Worker-architect]
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-Architect]
FAILED tests/unit/test_role_immutability.py::test_case_only_role_is_considered_same
FAILED tests/unit/test_services_event_bus.py::test_publish_subscribe_envelope_roundtrip
FAILED tests/unit/test_sse_resilience.py::test_sse_handles_cancelled_error - ...
FAILED tests/unit/test_sse_resilience.py::test_sse_pubsub_failure_does_not_500
FAILED tests/unit/test_sse_stability.py::test_sse_stream_connects_with_backoff
FAILED tests/unit/test_sse_stability.py::test_metrics_endpoint_exposes_sse_metrics
FAILED tests/unit/test_voice_ws.py::test_voice_ws_text_flow_dev_auth_disabled
FAILED tests/unit/test_voice_ws.py::test_voice_ws_rate_limit - starlette.webs...
=========== 44 failed, 47 passed, 103 warnings in 140.40s (0:02:20) ============
