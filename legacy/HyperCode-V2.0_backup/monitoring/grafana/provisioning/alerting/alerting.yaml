apiVersion: 1

contactPoints:
  - orgId: 1
    name: default-email
    receivers:
      - uid: email-receiver
        type: email
        settings:
          addresses: "devops@hypercode.com"

policies:
  - orgId: 1
    receiver: default-email
    group_by: ['grafana_folder', 'alertname']

groups:
  - orgId: 1
    name: "HyperCode Infrastructure"
    folder: "Infrastructure Alerts"
    interval: 1m
    rules:
      - uid: "cpu_usage_high"
        title: "High CPU Usage (>80%)"
        condition: "C"
        data:
          - refId: "A"
            relativeTimeRange: { from: 600, to: 0 }
            datasourceUid: "prometheus"
            model:
              expr: "sum(rate(container_cpu_usage_seconds_total{image!=''}[5m])) by (name) * 100"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: "A"
          - refId: "B"
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator: { params: [], type: "gt" }
                  operator: { type: "and" }
                  query: { params: [] }
                  reducer: { params: [], type: "last" }
                  type: "query"
              datasource: { type: "__expr__", uid: "__expr__" }
              expression: "A"
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: "last"
              refId: "B"
              type: "reduce"
          - refId: "C"
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator: { params: [0], type: "gt" }
                  operator: { type: "and" }
                  query: { params: [] }
                  reducer: { params: [], type: "last" }
                  type: "query"
              datasource: { type: "__expr__", uid: "__expr__" }
              expression: "$B > 80"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: "C"
              type: "math"
        noDataState: "OK"
        execErrState: "Error"
        for: "5m"
        annotations:
          summary: "High CPU on {{ $labels.name }}"
          description: "Container {{ $labels.name }} is using > 80% CPU."
        labels:
          severity: "warning"
