# üß† HyperCode Prometheus Mastery Guide

> **Objective**: Turn the development team into Observability Warlords.
> **Stack**: Prometheus, Grafana, AlertManager, NodeExporter, cAdvisor, RedisExporter.

---

## 1. The Theory (Why do we care?)
Monitoring is not just "looking at graphs." It is the **nervous system** of your application.
- **Metrics (Prometheus)**: "What is happening right now?" (e.g., CPU is at 80%).
- **Logs (Loki - Future)**: "Why did it happen?" (e.g., NullReferenceException).
- **Traces (Jaeger - Future)**: "Where did it happen?" (e.g., Database query took 5s).
- **Alerts (AlertManager)**: "Wake me up because it's broken."

## 2. The Stack Architecture
We are running a **Decoupled Monitoring Stack**. It lives on the `hypercode_hypernet` network but in its own `docker-compose.monitoring.yml` file.

| Service | Port | Role |
|:---|:---|:---|
| **Prometheus** | `:9090` | The Brain. Scrapes metrics from everyone else. |
| **Grafana** | `:3001` | The Face. Visualizes the data. (User: `admin` / Pass: `admin`) |
| **AlertManager** | `:9093` | The Town Crier. Handles alerts sent by Prometheus. |
| **Node Exporter** | `:9100` | The Doctor. Reports host (VM) hardware stats. |
| **cAdvisor** | `:8080` | The Container Spy. Reports resource usage per container. |
| **Redis Exporter** | `:9121` | The Memory Cache Monitor. |
| **Blackbox Exp** | `:9115` | The Pinger. Checks if endpoints (API, Health) are reachable. |

## 3. Hands-On Setup üõ†Ô∏è

### Prerequisite
Ensure the core network exists (usually created by the main stack):
```bash
docker network create hypercode_hypernet
```

### Launch the Stack
Run this command from the project root:
```bash
docker-compose -f docker-compose.monitoring.yml up -d
```

### Verification
1. **Prometheus**: Visit [http://localhost:9090](http://localhost:9090).
   - Go to **Status > Targets**. You should see targets for:
     - `hypercode-core`
     - `hyper-agents-box`
     - `broski-terminal`
     - Exporters (node, cadvisor, redis, blackbox)
2. **Grafana**: Visit [http://localhost:3001](http://localhost:3001).
   - Login with `admin` / `admin`.
   - Go to **Dashboards > Browse**.
   - You should see the **HyperCode Overview** dashboard pre-loaded.

## 4. Application Metrics üìä

We have instrumented the following services to expose native Prometheus metrics:

- **HyperCode Core** (`:8000/metrics`): Request latency, count, and custom business logic metrics.
- **Hyper-Agents-Box** (`:5000/metrics`): Agent activity and API health.
- **Broski Terminal** (`:3000/api/metrics`): Frontend API route latency and Next.js internals.

### SSE Agent Registry Metrics
- `agent_stream_latency_ms` histogram with labels: method, status, env, version
- `agent_stream_clients_total` counter tagged by env, version
- `agent_registry_errors_total` counter labeled by operation, env, version

### Recording Rules
- Latency quantiles: `job:agent_stream_latency_ms:hist_p50`, `hist_p95`, `hist_p99`
- Clients rate: `job:agent_stream_clients_total:rate_5m`
- Error rate: `job:agent_registry_errors_total:rate_5m`

### Alerts
- High p95 latency > 500ms for 5m
- No SSE clients for 10m
- Elevated error rate > 0.1/s for 10m

### Grafana Dashboards
- Import `monitoring/grafana/dashboards/sse_agent_registry.json`
- Panels: SSE clients rate, latency quantiles, error rate by operation, throughput

## 7. Test Execution Procedures
Run unit tests:
```
pytest -q
```

Key suites:
- SSE emission and resilience tests
- Metrics latency validation
- Heartbeat lifecycle and timeout handling

## 5. PromQL Cheat Sheet (Copy-Paste Magic) üßô‚Äç‚ôÇÔ∏è

**Basic Health Check:**
```promql
up
```
*Returns 1 if the target is up, 0 if down.*

**Container CPU Usage (Top 5):**
```promql
topk(5, rate(container_cpu_usage_seconds_total[5m]))
```

**Memory Usage by Container Name:**
```promql
sum(container_memory_usage_bytes) by (name)
```

**Average API Response Time (Global):**
```promql
rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])
```

## 6. Next Steps
- **Import Community Dashboards**: Use ID `1860` for Node Exporter or `14282` for cAdvisor.
- **Silence Alerts**: Go to [http://localhost:9093](http://localhost:9093) to manage silences during maintenance.

---
*Generated by Trae - HyperCode DevOps Assistant*
