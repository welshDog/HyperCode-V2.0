version: "3.9"

networks:
  platform-net:
    driver: bridge
    name: hypercode_platform_net

volumes:
  redis-data:
  postgres-data:
  grafana-data:

services:
  # HyperCode Core
  hypercode-core:
    build:
      context: ./HyperCode-V2.0/THE HYPERCODE/hypercode-core
      dockerfile: Dockerfile
    container_name: hypercode-core
    environment:
      - ENVIRONMENT=local
      - HYPERCODE_REDIS_URL=redis://redis:6379/0
      - HYPERCODE_DB_URL=postgresql://postgres:${POSTGRES_PASSWORD:-changeme}@postgres:5432/hypercode
      - HYPERCODE_MEMORY_KEY=${HYPERCODE_MEMORY_KEY}
      - API_KEY=
      - OTLP_EXPORTER_DISABLED=false
      - OTLP_ENDPOINT=http://jaeger:4318/v1/traces
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - platform-net
    ports:
      - "8000:8000"
    restart: unless-stopped

  dashboard:
    image: nginx:alpine
    container_name: hypercode-dashboard
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - "8088:80"
    volumes:
      - ./agents/dashboard:/usr/share/nginx/html:ro
    depends_on:
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  # Crew Orchestrator
  crew-orchestrator:
    build:
      context: ./agents/crew-orchestrator
      dockerfile: Dockerfile
    container_name: crew-orchestrator
    environment:
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CORE_URL=http://hypercode-core:8000
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    ports:
      - "8080:8080"
    restart: unless-stopped

  # Agents (Tier 2)
  frontend-specialist:
    build:
      context: ./agents/01-frontend-specialist
    container_name: frontend-specialist
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://frontend-specialist:8002/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  backend-specialist:
    build:
      context: ./agents/02-backend-specialist
    container_name: backend-specialist
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://backend-specialist:8003/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  database-architect:
    build:
      context: ./agents/03-database-architect
    container_name: database-architect
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://database-architect:8004/health
      - POSTGRES_URL=postgresql://postgres:${POSTGRES_PASSWORD:-changeme}@postgres:5432/hypercode
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  qa-engineer:
    build:
      context: ./agents/04-qa-engineer
    container_name: qa-engineer
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://qa-engineer:8005/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  devops-engineer:
    build:
      context: ./agents/05-devops-engineer
    container_name: devops-engineer
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://devops-engineer:8006/health
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  security-engineer:
    build:
      context: ./agents/06-security-engineer
    container_name: security-engineer
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://security-engineer:8007/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  system-architect:
    build:
      context: ./agents/07-system-architect
    container_name: system-architect
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://system-architect:8008/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  project-strategist:
    build:
      context: ./agents/08-project-strategist
    container_name: project-strategist
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - CORE_URL=http://hypercode-core:8000
      - AGENT_HEALTH_URL=http://project-strategist:8001/health
    volumes:
      - ./Configuration_Kit:/app/hive_mind:ro
      - ./agents/base-agent/agent.py:/app/base_agent.py:ro
    depends_on:
      redis:
        condition: service_healthy
      hypercode-core:
        condition: service_healthy
    networks:
      - platform-net
    restart: unless-stopped

  llama:
    image: ollama/ollama:latest
    container_name: hypercode-llama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ./data/ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 4G
    networks:
      - platform-net

  # Infrastructure
  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    networks:
      - platform-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=hypercode
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - platform-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Observability
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./HyperCode-V2.0/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./HyperCode-V2.0/monitoring/prometheus:/etc/prometheus/monitoring:ro
    networks:
      - platform-net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.3
    container_name: grafana
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./HyperCode-V2.0/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./HyperCode-V2.0/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - platform-net
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:1.56
    container_name: jaeger
    ports:
      - "16686:16686"
    networks:
      - platform-net
    restart: unless-stopped
