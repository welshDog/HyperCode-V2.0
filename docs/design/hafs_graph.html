
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hyper AI File System - Neural Graph</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #fff; font-family: sans-serif; overflow: hidden; }
        #graph { width: 100vw; height: 100vh; }
        .node circle { stroke: #fff; stroke-width: 1.5px; }
        .link { stroke: #555; stroke-opacity: 0.6; }
        .label { font-size: 10px; fill: #ccc; pointer-events: none; }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div id="tooltip" class="tooltip"></div>
    <div id="graph"></div>

    <script>
        // Load the graph data
        d3.json("../../.ai/MASTER_INDEX.json").then(function(data) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Transform HAFS data to D3 format
            // HAFS: { nodes: { "path": {data} }, edges: [ {source, target} ] }
            // D3: { nodes: [ {id, ...} ], links: [ {source, target} ] }
            
            const nodes = Object.entries(data.graph.nodes).map(([id, meta]) => ({
                id: id,
                group: meta.layer || "other",
                type: meta.type,
                size: meta.size
            }));
            
            const links = data.graph.edges.map(e => ({
                source: e.source,
                target: e.target,
                type: e.relation
            })).filter(l => nodes.find(n => n.id === l.source) && nodes.find(n => n.id === l.target)); // Filter broken links

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(15));

            const svg = d3.select("#graph").append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }));

            const g = svg.append("g");

            const link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", 1);

            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("r", 5)
                .attr("fill", d => color(d.group))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("title")
                .text(d => d.id);
            
            // Hover Tooltip
            const tooltip = d3.select("#tooltip");
            node.on("mouseover", (event, d) => {
                tooltip.style("display", "block")
                    .html(`<strong>${d.id}</strong><br>Layer: ${d.group}<br>Type: ${d.type}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            }).on("mouseout", () => {
                tooltip.style("display", "none");
            });

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        });
    </script>
</body>
</html>
