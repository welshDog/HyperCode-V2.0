# Security Threat Model

> **built with WelshDog + BROski ðŸš€ðŸŒ™**

This document outlines the security threat model for HyperCode V2.0, focusing on the risks associated with autonomous code execution and Docker integration.

## System Boundaries
- **Trust Boundary 1:** User <-> Frontend (Authentication required)
- **Trust Boundary 2:** Backend <-> Docker Engine (Critical interface)
- **Trust Boundary 3:** Agent Container <-> External Network (Restricted)

## Identified Threats & Mitigations

### 1. Unrestricted Docker Socket Access
- **Threat:** An attacker compromising the Coder Agent could gain root access to the host machine via the mounted Docker socket (`/var/run/docker.sock`).
- **Severity:** Critical.
- **Mitigation:**
  - **Docker MCP:** We utilize the Model Context Protocol (MCP) to abstract Docker interactions. The `docker-mcp` tool is installed in an isolated environment (`pipx`) and accessed via a defined interface.
  - **Security Policy:** A strict `SecurityPolicy` class intercepts all tool calls, validating image names against an allowlist before execution.
  - **Socket Proxy:** (Recommended) Use a Docker socket proxy (e.g., `tecnativa/docker-socket-proxy`) to whitelist only necessary API calls.
  - **Least Privilege:** The Coder Agent runs as a non-root user (where possible) or with restricted capabilities.
  - **Validation:** All Docker commands generated by the agent are validated against a strictly allowed schema before execution.

### 2. Arbitrary Code Execution (RCE)
- **Threat:** The Coder Agent executes malicious code generated by the LLM.
- **Severity:** High.
- **Mitigation:**
  - **Ephemeral Containers:** All code execution happens in ephemeral, isolated Docker containers that are destroyed after the task.
  - **Network Isolation:** Execution containers have no internet access unless explicitly whitelisted for package installation.
  - **Resource Limits:** Containers are capped on CPU and RAM to prevent DoS.

### 3. Prompt Injection
- **Threat:** Malicious user input manipulates the Agent to ignore safety constraints.
- **Severity:** Medium.
- **Mitigation:**
  - **System Prompt Hardening:** Core instructions strictly forbid bypassing safety protocols.
  - **Input Sanitization:** All user inputs are sanitized before being fed to the LLM context.

### 4. Data Leakage
- **Threat:** Sensitive environment variables or keys leak into logs or agent outputs.
- **Severity:** High.
- **Mitigation:**
  - **Secret Management:** Secrets are injected at runtime and never stored in code.
  - **Log Scrubbing:** The logging pipeline includes patterns to redact potential keys/tokens.

### 5. Unauthorized Agent Access
- **Threat:** Rogue services or attackers spoofing agents to inject false data or steal tasks.
- **Severity:** High.
- **Mitigation:**
  - **RBAC:** Role-Based Access Control implemented on `hypercode-core`.
  - **API Keys:** Agents authenticate via `X-API-Key` with restricted scopes (`agent:register`, `agent:heartbeat`).
  - **JWT Verification:** Strict JWT signature verification with environment-specific secrets.

## Security Checklist
- [x] Docker socket mounted with read-only permissions where possible (or proxied).
- [x] API authentication enabled (JWT & API Key RBAC).
- [x] HTTPS enabled for all external traffic (in production).
- [x] Regular dependency scanning (trivy/dependabot).
- [x] Agent endpoints protected by RBAC scopes.

---
> **built with WelshDog + BROski ðŸš€ðŸŒ™**
