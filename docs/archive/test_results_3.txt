============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pytest.ini
testpaths: tests
plugins: asyncio-1.3.0, anyio-4.12.1, cov-4.1.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 91 items

tests/e2e/test_integration_bridge.py::test_agent_registration_e2e FAILED [  1%]
tests/e2e/test_integration_bridge.py::test_mission_submission_e2e FAILED [  2%]
tests/e2e/test_integration_bridge.py::test_telemetry_aggregation_e2e PASSED [  3%]
tests/perf/test_engine_latency.py::test_engine_run_latency_distribution PASSED [  4%]
tests/perf/test_interpreter_perf.py::test_perf_simple_loop_under_threshold PASSED [  5%]
tests/unit/test_agent_registry_acceptance.py::test_duplicate_payload_returns_200 FAILED [  6%]
tests/unit/test_agent_registry_acceptance.py::test_immutable_role_change_rejected_422 FAILED [  7%]
tests/unit/test_agent_registry_acceptance.py::test_version_minor_bumps_and_patch_resets_on_dedup_re_register FAILED [  8%]
tests/unit/test_agent_registry_idempotent.py::test_sse_stream_endpoint_available PASSED [  9%]
tests/unit/test_agent_registry_idempotent.py::test_idempotent_registration_by_dedup_key PASSED [ 10%]
tests/unit/test_agent_registry_idempotent.py::test_metrics_exposed PASSED [ 12%]
tests/unit/test_agents.py::test_register_agent PASSED                    [ 13%]
tests/unit/test_agents.py::test_get_agents PASSED                        [ 14%]
tests/unit/test_agents.py::test_heartbeat PASSED                         [ 15%]
tests/unit/test_agents.py::test_sse_stream_endpoint_sync FAILED          [ 16%]
tests/unit/test_auth_config.py::test_security_validation_dev PASSED      [ 17%]
tests/unit/test_auth_config.py::test_security_validation_prod_missing PASSED [ 18%]
tests/unit/test_auth_config.py::test_security_validation_prod_short FAILED [ 19%]
tests/unit/test_auth_config.py::test_security_validation_prod_valid FAILED [ 20%]
tests/unit/test_circuit_breaker.py::test_circuit_breaker_opens_after_failures PASSED [ 21%]
tests/unit/test_collaboration_efficiency.py::test_agents_collaboration_register_list_heartbeat FAILED [ 23%]
tests/unit/test_dlq_consumer.py::test_dlq_publish_and_persist PASSED     [ 24%]
tests/unit/test_engine_adapter.py::test_adapter_api_path PASSED          [ 25%]
tests/unit/test_engine_adapter.py::test_adapter_cli_path PASSED          [ 26%]
tests/unit/test_engine_adapter_payload.py::test_adapter_forwards_env_and_target PASSED [ 27%]
tests/unit/test_engine_run_route.py::test_engine_run_route PASSED        [ 28%]
tests/unit/test_error_handling.py::test_agent_register_role_change_422 FAILED [ 29%]
tests/unit/test_error_handling.py::test_execution_error_status PASSED    [ 30%]
tests/unit/test_event_bus.py::test_publish_subscribe_roundtrip PASSED    [ 31%]
tests/unit/test_execute_hc.py::test_execute_hc_eval_print PASSED         [ 32%]
tests/unit/test_execute_hc_file.py::test_execute_hc_file_run FAILED      [ 34%]
tests/unit/test_hc_parser.py::test_parse_hc_mission_block PASSED         [ 35%]
tests/unit/test_health.py::test_health_check PASSED                      [ 36%]
tests/unit/test_heartbeat_lifecycle.py::test_heartbeat_full_lifecycle PASSED [ 37%]
tests/unit/test_heartbeat_lifecycle.py::test_timeout_marks_offline PASSED [ 38%]
tests/unit/test_hypercode_cli_target.py::test_cli_includes_target_flag PASSED [ 39%]
tests/unit/test_immutable_error_payload.py::test_immutable_role_error_payload FAILED [ 40%]
tests/unit/test_interpreter_constructs.py::test_if_else PASSED           [ 41%]
tests/unit/test_interpreter_constructs.py::test_while_loop_break PASSED  [ 42%]
tests/unit/test_interpreter_constructs.py::test_for_loop_continue PASSED [ 43%]
tests/unit/test_interpreter_constructs.py::test_function_decl_and_call PASSED [ 45%]
tests/unit/test_interpreter_constructs.py::test_scoping_variables PASSED [ 46%]
tests/unit/test_interpreter_constructs.py::test_operators_and_expressions PASSED [ 47%]
tests/unit/test_interpreter_errors.py::test_undefined_name_error PASSED  [ 48%]
tests/unit/test_interpreter_errors.py::test_unsupported_node_error PASSED [ 49%]
tests/unit/test_interpreter_metrics.py::test_interpreter_metrics_success_exposed PASSED [ 50%]
tests/unit/test_interpreter_metrics.py::test_interpreter_metrics_error_exposed PASSED [ 51%]
tests/unit/test_key_manager.py::test_generate_list_validate_revoke PASSED [ 52%]
tests/unit/test_key_manager.py::test_api_key_fallback PASSED             [ 53%]
tests/unit/test_memory_service.py::test_memory_crud_and_search FAILED    [ 54%]
tests/unit/test_memory_service.py::test_memory_cleanup_expired PASSED    [ 56%]
tests/unit/test_metrics_latency.py::test_stream_latency_metric_observed PASSED [ 57%]
tests/unit/test_mission_flow_report.py::test_mission_flow_and_report FAILED [ 58%]
tests/unit/test_mission_lifecycle.py::test_mission_full_lifecycle FAILED [ 59%]
tests/unit/test_nd_errors.py::test_undefined_name_error_with_suggestions PASSED [ 60%]
tests/unit/test_nd_errors.py::test_syntax_error_formatting PASSED        [ 61%]
tests/unit/test_nd_errors.py::test_type_error_explanation PASSED         [ 62%]
tests/unit/test_nd_errors.py::test_unsupported_feature_helpful PASSED    [ 63%]
tests/unit/test_nd_errors.py::test_similar_names_detection PASSED        [ 64%]
tests/unit/test_orchestrator_selection.py::test_orchestrator_assign_prefers_capability_and_health FAILED [ 65%]
tests/unit/test_parser.py::test_parse_hello_world PASSED                 [ 67%]
tests/unit/test_parser.py::test_parse_assignment PASSED                  [ 68%]
tests/unit/test_parser.py::test_parse_function_def PASSED                [ 69%]
tests/unit/test_rate_limit.py::test_rate_limiter_redis_allowed FAILED    [ 70%]
tests/unit/test_rate_limit.py::test_rate_limiter_redis_blocked FAILED    [ 71%]
tests/unit/test_rate_limit.py::test_rate_limiter_fallback FAILED         [ 72%]
tests/unit/test_rate_limit.py::test_check_rate_limit_dependency PASSED   [ 73%]
tests/unit/test_report_endpoint.py::test_report_endpoint_success PASSED  [ 74%]
tests/unit/test_report_endpoint.py::test_report_endpoint_error PASSED    [ 75%]
tests/unit/test_report_endpoint.py::test_report_endpoint_invalid_json PASSED [ 76%]
tests/unit/test_retry_backoff.py::test_schedule_retry_exponential_backoff_and_jitter PASSED [ 78%]
tests/unit/test_retry_backoff.py::test_max_retries_prevents_scheduling PASSED [ 79%]
tests/unit/test_retry_integration.py::test_retry_flow_schedules_and_requeues PASSED [ 80%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-architect] FAILED [ 81%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[Worker-architect] FAILED [ 82%]
tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-Architect] FAILED [ 83%]
tests/unit/test_role_immutability.py::test_case_only_role_is_considered_same FAILED [ 84%]
tests/unit/test_services_event_bus.py::test_publish_subscribe_envelope_roundtrip PASSED [ 85%]
tests/unit/test_sse_emission.py::test_sse_emits_valid_messages PASSED    [ 86%]
tests/unit/test_sse_emission.py::test_sse_handles_malformed_data PASSED  [ 87%]
tests/unit/test_sse_emission.py::test_sse_high_frequency PASSED          [ 89%]
tests/unit/test_sse_emission.py::test_sse_connection_recovers PASSED     [ 90%]
tests/unit/test_sse_resilience.py::test_sse_handles_cancelled_error FAILED [ 91%]
tests/unit/test_sse_resilience.py::test_sse_pubsub_failure_does_not_500 FAILED [ 92%]
tests/unit/test_sse_stability.py::test_sse_stream_connects_with_backoff FAILED [ 93%]
tests/unit/test_sse_stability.py::test_metrics_endpoint_exposes_sse_metrics PASSED [ 94%]
tests/unit/test_voice_service.py::test_dc_offset_filter_reduces_offset PASSED [ 95%]
tests/unit/test_voice_service.py::test_agc_scales_signal PASSED          [ 96%]
tests/unit/test_voice_service.py::test_audio_buffer_window_and_transcribe PASSED [ 97%]
tests/unit/test_voice_ws.py::test_voice_ws_text_flow_dev_auth_disabled FAILED [ 98%]
tests/unit/test_voice_ws.py::test_voice_ws_rate_limit FAILED             [100%]

=================================== FAILURES ===================================
_________________________ test_agent_registration_e2e __________________________

    def test_agent_registration_e2e():
        payload = {
            "name": "integration-agent",
            "role": "worker",
            "version": "1.0.0",
            "capabilities": ["integration"],
            "topics": ["agent.events"],
            "health_url": "http://integration-agent:9000/health",
            "dedup_key": "integration-agent"
        }
>       r1 = client.post("/agents/register", json=payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_integration_bridge.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba3d030d0 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba3d030d0 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0929s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.167s
Running query engine on port 43023
Starting query engine...
Constructed GET request to http://localhost:43023/status
Request headers: {'Accept': 'application/json'}
Request content: None
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:02.977427Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
{"timestamp":"2026-02-06T20:03:03.030907Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:43023","ip":"127.0.0.1","port":"43023"},"target":"query_engine::server"}
Constructed GET request to http://localhost:43023/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:43023/status "HTTP/1.1 200 OK"
GET http://localhost:43023/status returned status 200
GET http://localhost:43023/status returned {'status': 'ok'}
Connecting to query engine took 0.3587s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0929s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.167s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 43023
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:43023/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:43023/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:43023/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:43023/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:43023/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.3587s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "integration-agent"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:43023/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"integration-agent\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba3d030d0 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "integration-agent"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:43023/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"integration-agent\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba3d030d0 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_________________________ test_mission_submission_e2e __________________________

self = <redis.asyncio.connection.Connection(host=redis,port=6379,db=0)>
disable_decoding = False, timeout = None

    async def read_response(
        self,
        disable_decoding: bool = False,
        timeout: Optional[float] = None,
        *,
        disconnect_on_error: bool = True,
        push_request: Optional[bool] = False,
    ):
        """Read the response from a previously sent command"""
        read_timeout = timeout if timeout is not None else self.socket_timeout
        host_error = self._host_error()
        try:
            if read_timeout is not None and self.protocol in ["3", 3]:
                async with async_timeout(read_timeout):
                    response = await self._parser.read_response(
                        disable_decoding=disable_decoding, push_request=push_request
                    )
            elif read_timeout is not None:
                async with async_timeout(read_timeout):
                    response = await self._parser.read_response(
                        disable_decoding=disable_decoding
                    )
            elif self.protocol in ["3", 3]:
                response = await self._parser.read_response(
                    disable_decoding=disable_decoding, push_request=push_request
                )
            else:
>               response = await self._parser.read_response(
                    disable_decoding=disable_decoding
                )

/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:607: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py:82: in read_response
    response = await self._read_response(disable_decoding=disable_decoding)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py:90: in _read_response
    raw = await self._readline()
          ^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/_parsers/base.py:468: in _readline
    data = await self._stream.readline()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:566: in readline
    line = await self.readuntil(sep)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:658: in readuntil
    await self._wait_for_data('readuntil')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=22>>
func_name = 'readuntil'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259> cb=[TaskGroup._spawn.<locals>.task_done() at /usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:805]> got Future <Future pending> attached to a different loop

/usr/local/lib/python3.11/asyncio/streams.py:543: RuntimeError

During handling of the above exception, another exception occurred:

    def test_mission_submission_e2e():
        req = {
            "title": "Integration Mission",
            "priority": 80,
            "payload": {
                "requirements": {"capabilities": ["frontend", "backend"]},
                "plan_id": "plan-123"
            }
        }
        r = client.post("/orchestrator/mission", json=req)
        assert r.status_code == 200
        mid = r.json()["id"]
        assert mid
        # Transition to executing and completed
>       r2 = client.post(f"/orchestrator/{mid}/start")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_integration_bridge.py:45: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/orchestrator.py:35: in start
    res = await orchestrator.start(mission_id)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:362: in start
    return await self._transition(mission_id, MissionState.EXECUTING)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:295: in _transition
    v = await self.redis.hgetall(k)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:725: in execute_command
    return await conn.retry.call_with_retry(
/usr/local/lib/python3.11/site-packages/redis/asyncio/retry.py:50: in call_with_retry
    return await do()
           ^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:700: in _send_command_parse_response
    return await self.parse_response(conn, command_name, **options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/client.py:746: in parse_response
    response = await connection.read_response()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:627: in read_response
    await self.disconnect(nowait=True)
/usr/local/lib/python3.11/site-packages/redis/asyncio/connection.py:487: in disconnect
    self._writer.close()  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/streams.py:358: in close
    return self._transport.close()
           ^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/asyncio/selector_events.py:864: in close
    self._loop.call_soon(self._call_connection_lost, None)
/usr/local/lib/python3.11/asyncio/base_events.py:762: in call_soon
    self._check_closed()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=True debug=False>

    def _check_closed(self):
        if self._closed:
>           raise RuntimeError('Event loop is closed')
E           RuntimeError: Event loop is closed

/usr/local/lib/python3.11/asyncio/base_events.py:520: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0067s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0118s
Running query engine on port 35681
Starting query engine...
Constructed GET request to http://localhost:35681/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:08.349590Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:08.379534Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:35681","ip":"127.0.0.1","port":"35681"},"target":"query_engine::server"}
Constructed GET request to http://localhost:35681/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:35681/status "HTTP/1.1 200 OK"
GET http://localhost:35681/status returned status 200
GET http://localhost:35681/status returned {'status': 'ok'}
Connecting to query engine took 0.1753s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0067s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0118s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 35681
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:35681/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:35681/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:35681/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:35681/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:35681/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1753s
----------------------------- Captured stdout call -----------------------------
Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "6fada415-366b-4216-b9c9-6157a22a5c4d"
      title: "Integration Mission"
      status: "queued"
      userId: "system"
      payload: {
        requirements: {
          capabilities: [,
            "frontend",
            "backend",
          ]
        }
        plan_id: "plan-123"
      }
      createdAt: "2026-02-06T20:03:08.529000+00:00"
      updatedAt: "2026-02-06T20:03:08.529000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:35681/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"6fada415-366b-4216-b9c9-6157a22a5c4d\"\n      title: \"Integration Mission\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        requirements: {\n          capabilities: [,\n            \"frontend\",\n            \"backend\",\n          ]\n        }\n        plan_id: \"plan-123\"\n      }\n      createdAt: \"2026-02-06T20:03:08.529000+00:00\"\n      updatedAt: \"2026-02-06T20:03:08.529000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
[2m2026-02-06T20:03:08.545100Z[0m [[31m[1merror    [0m] [1mPersistence failed for mission 6fada415-366b-4216-b9c9-6157a22a5c4d: <asyncio.locks.Event object at 0x744ba1288c10 [unset]> is bound to a different event loop[0m
HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "6fada415-366b-4216-b9c9-6157a22a5c4d"
      title: "Integration Mission"
      status: "queued"
      userId: "system"
      payload: {
        requirements: {
          capabilities: [,
            "frontend",
            "backend",
          ]
        }
        plan_id: "plan-123"
      }
      createdAt: "2026-02-06T20:03:08.529000+00:00"
      updatedAt: "2026-02-06T20:03:08.529000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:35681/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"6fada415-366b-4216-b9c9-6157a22a5c4d\"\n      title: \"Integration Mission\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        requirements: {\n          capabilities: [,\n            \"frontend\",\n            \"backend\",\n          ]\n        }\n        plan_id: \"plan-123\"\n      }\n      createdAt: \"2026-02-06T20:03:08.529000+00:00\"\n      updatedAt: \"2026-02-06T20:03:08.529000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______________________ test_duplicate_payload_returns_200 ______________________

    def test_duplicate_payload_returns_200():
        client = TestClient(app)
        payload = {
            "name": "Agent A",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5001/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000AA",
        }
>       r1 = client.post("/agents/register", json=payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:17: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba162d550 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba162d550 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0107s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0141s
Running query engine on port 39791
Starting query engine...
Constructed GET request to http://localhost:39791/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:24.154743Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:24.183129Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:39791","ip":"127.0.0.1","port":"39791"},"target":"query_engine::server"}
Constructed GET request to http://localhost:39791/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:39791/status "HTTP/1.1 200 OK"
GET http://localhost:39791/status returned status 200
GET http://localhost:39791/status returned {'status': 'ok'}
Connecting to query engine took 0.1898s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0107s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0141s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 39791
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:39791/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:39791/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:39791/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:39791/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:39791/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1898s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000AA"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:39791/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000AA\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba162d550 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000AA"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:39791/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000AA\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba162d550 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
___________________ test_immutable_role_change_rejected_422 ____________________

    def test_immutable_role_change_rejected_422():
        client = TestClient(app)
        base = {
            "name": "Agent B",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5002/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000BB",
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba1022250 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba1022250 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0091s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.013s
Running query engine on port 52055
Starting query engine...
Constructed GET request to http://localhost:52055/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:28.818430Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:28.852377Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:52055","ip":"127.0.0.1","port":"52055"},"target":"query_engine::server"}
Constructed GET request to http://localhost:52055/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:52055/status "HTTP/1.1 200 OK"
GET http://localhost:52055/status returned status 200
GET http://localhost:52055/status returned {'status': 'ok'}
Connecting to query engine took 0.1913s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0091s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.013s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 52055
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:52055/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:52055/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:52055/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:52055/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:52055/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1913s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000BB"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:52055/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000BB\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba1022250 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000BB"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:52055/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000BB\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba1022250 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
________ test_version_minor_bumps_and_patch_resets_on_dedup_re_register ________

    def test_version_minor_bumps_and_patch_resets_on_dedup_re_register():
        client = TestClient(app)
        data = {
            "name": "Agent C",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c1"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5003/health",
            "dedup_key": "00000000-0000-0000-0000-0000000000CC",
        }
>       r1 = client.post("/agents/register", json=data)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_agent_registry_acceptance.py:53: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba049efd0 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba049efd0 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0064s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.01s
Running query engine on port 57855
Starting query engine...
Constructed GET request to http://localhost:57855/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:33.223698Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:33.252830Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:57855","ip":"127.0.0.1","port":"57855"},"target":"query_engine::server"}
Constructed GET request to http://localhost:57855/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:57855/status "HTTP/1.1 200 OK"
GET http://localhost:57855/status returned status 200
GET http://localhost:57855/status returned {'status': 'ok'}
Connecting to query engine took 0.1751s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0064s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.01s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 57855
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:57855/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:57855/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:57855/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:57855/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:57855/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1751s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000CC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:57855/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000CC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba049efd0 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-0000000000CC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:57855/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-0000000000CC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba049efd0 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
________________________ test_sse_stream_endpoint_sync _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_agents.py", line 57, in test_sse_stream_endpoint_sync
  |     resp = client.get("/agents/watch?one_shot=true")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x744ba0da86d0 [unset]> is bound to a different event loop
    +------------------------------------
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0071s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0125s
Running query engine on port 38363
Starting query engine...
Constructed GET request to http://localhost:38363/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:39.513079Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:39.541285Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:38363","ip":"127.0.0.1","port":"38363"},"target":"query_engine::server"}
Constructed GET request to http://localhost:38363/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:38363/status "HTTP/1.1 200 OK"
GET http://localhost:38363/status returned status 200
GET http://localhost:38363/status returned {'status': 'ok'}
Connecting to query engine took 0.1919s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0071s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0125s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 38363
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:38363/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:38363/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:38363/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:38363/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:38363/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1919s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_____________________ test_security_validation_prod_short ______________________

    def test_security_validation_prod_short():
        # Production short secret should fail
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET="short", HYPERCODE_DB_URL="sqlite://")
        with pytest.raises(ValueError, match="too short"):
>           s.validate_security()

tests/unit/test_auth_config.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='HyperCode Core', ENVIRONMENT='production', OPENAI_API_KEY='sk-placeholder-key', HYPERCODE_DB_URL='s...t:6379/0', CELERY_RESULT_BACKEND='redis://localhost:6379/0', RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_MAX_REQUESTS=100)

    def validate_security(self):
        # Allow dev/test bypass
        if self.ENVIRONMENT.lower() in ("development", "test"):
            return
    
        if not self.API_KEY:
>           raise ValueError("API_KEY is missing in production/staging!")
E           ValueError: API_KEY is missing in production/staging!

app/core/config.py:25: ValueError

During handling of the above exception, another exception occurred:

    def test_security_validation_prod_short():
        # Production short secret should fail
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET="short", HYPERCODE_DB_URL="sqlite://")
>       with pytest.raises(ValueError, match="too short"):
E       AssertionError: Regex pattern did not match.
E         Expected regex: 'too short'
E         Actual message: 'API_KEY is missing in production/staging!'

tests/unit/test_auth_config.py:19: AssertionError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0069s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0102s
Running query engine on port 52409
Starting query engine...
Constructed GET request to http://localhost:52409/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:40.323783Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:40.352663Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:52409","ip":"127.0.0.1","port":"52409"},"target":"query_engine::server"}
Constructed GET request to http://localhost:52409/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:52409/status "HTTP/1.1 200 OK"
GET http://localhost:52409/status returned status 200
GET http://localhost:52409/status returned {'status': 'ok'}
Connecting to query engine took 0.1774s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0069s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0102s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 52409
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:52409/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:52409/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:52409/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:52409/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:52409/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1774s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_____________________ test_security_validation_prod_valid ______________________

    def test_security_validation_prod_valid():
        # Production valid secret should pass
        valid_secret = "a" * 32
        s = Settings(ENVIRONMENT="production", HYPERCODE_JWT_SECRET=valid_secret, HYPERCODE_DB_URL="sqlite://")
>       s.validate_security() # Should not raise
        ^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_auth_config.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='HyperCode Core', ENVIRONMENT='production', OPENAI_API_KEY='sk-placeholder-key', HYPERCODE_DB_URL='s...t:6379/0', CELERY_RESULT_BACKEND='redis://localhost:6379/0', RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_MAX_REQUESTS=100)

    def validate_security(self):
        # Allow dev/test bypass
        if self.ENVIRONMENT.lower() in ("development", "test"):
            return
    
        if not self.API_KEY:
>           raise ValueError("API_KEY is missing in production/staging!")
E           ValueError: API_KEY is missing in production/staging!

app/core/config.py:25: ValueError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0067s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0113s
Running query engine on port 53227
Starting query engine...
Constructed GET request to http://localhost:53227/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:40.691773Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:40.720640Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:53227","ip":"127.0.0.1","port":"53227"},"target":"query_engine::server"}
Constructed GET request to http://localhost:53227/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:53227/status "HTTP/1.1 200 OK"
GET http://localhost:53227/status returned status 200
GET http://localhost:53227/status returned {'status': 'ok'}
Connecting to query engine took 0.1757s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0067s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0113s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 53227
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53227/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53227/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:53227/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:53227/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:53227/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1757s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______________ test_agents_collaboration_register_list_heartbeat _______________

    def test_agents_collaboration_register_list_heartbeat():
        client = TestClient(app)
        a1 = {
            "name": "Crew Worker 1",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5002/health",
            "dedup_key": "00000000-0000-0000-0000-00000000W1",
        }
        a2 = {
            "name": "Crew Worker 2",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5003/health",
            "dedup_key": "00000000-0000-0000-0000-00000000W2",
        }
>       r1 = client.post("/agents/register", json=a1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_collaboration_efficiency.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba230e110 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba230e110 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0092s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0124s
Running query engine on port 49495
Starting query engine...
Constructed GET request to http://localhost:49495/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:41.415784Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:41.446269Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:49495","ip":"127.0.0.1","port":"49495"},"target":"query_engine::server"}
Constructed GET request to http://localhost:49495/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:49495/status "HTTP/1.1 200 OK"
GET http://localhost:49495/status returned status 200
GET http://localhost:49495/status returned {'status': 'ok'}
Connecting to query engine took 0.1789s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0092s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0124s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 49495
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49495/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49495/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:49495/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:49495/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:49495/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1789s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000W1"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:49495/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000W1\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba230e110 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000W1"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:49495/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000W1\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba230e110 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_____________________ test_agent_register_role_change_422 ______________________

    def test_agent_register_role_change_422():
        client = TestClient(app)
        base = {
            "name": "Crew A",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["c"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5001/health",
            "dedup_key": "00000000-0000-0000-0000-00000000RC",
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_error_handling.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba0ee9250 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba0ee9250 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0103s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0141s
Running query engine on port 49007
Starting query engine...
Constructed GET request to http://localhost:49007/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:48.258243Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:48.299070Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:49007","ip":"127.0.0.1","port":"49007"},"target":"query_engine::server"}
Constructed GET request to http://localhost:49007/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:49007/status "HTTP/1.1 200 OK"
GET http://localhost:49007/status returned status 200
GET http://localhost:49007/status returned {'status': 'ok'}
Connecting to query engine took 0.1817s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0103s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0141s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 49007
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49007/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49007/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:49007/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:49007/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:49007/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1817s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:49007/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba0ee9250 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:49007/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba0ee9250 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
___________________________ test_execute_hc_file_run ___________________________

    def test_execute_hc_file_run():
        client = TestClient(app)
        with tempfile.NamedTemporaryFile("w", delete=False, suffix=".hc", encoding="utf-8") as tf:
            tf.write('print "From File"')
            temp_path = tf.name
        try:
            resp = client.post("/execution/execute-hc-file", json={"path": temp_path})
>           assert resp.status_code == 200
E           assert 400 == 200
E            +  where 400 = <Response [400 Bad Request]>.status_code

tests/unit/test_execute_hc_file.py:13: AssertionError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0094s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0128s
Running query engine on port 53105
Starting query engine...
Constructed GET request to http://localhost:53105/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:55.252459Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:55.283318Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:53105","ip":"127.0.0.1","port":"53105"},"target":"query_engine::server"}
Constructed GET request to http://localhost:53105/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:53105/status "HTTP/1.1 200 OK"
GET http://localhost:53105/status returned status 200
GET http://localhost:53105/status returned {'status': 'ok'}
Connecting to query engine took 0.1789s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0094s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0128s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 53105
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53105/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53105/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:53105/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:53105/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:53105/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1789s
----------------------------- Captured stdout call -----------------------------
HTTP Request: POST http://testserver/execution/execute-hc-file "HTTP/1.1 400 Bad Request"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/execution/execute-hc-file "HTTP/1.1 400 Bad Request"
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______________________ test_immutable_role_error_payload _______________________

    def test_immutable_role_error_payload():
        client = TestClient(app)
        base = {
            "name": "Immut",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000IM"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_immutable_error_payload.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba108ac90 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba108ac90 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0107s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0142s
Running query engine on port 44113
Starting query engine...
Constructed GET request to http://localhost:44113/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:03:57.480268Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:03:57.514276Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:44113","ip":"127.0.0.1","port":"44113"},"target":"query_engine::server"}
Constructed GET request to http://localhost:44113/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:44113/status "HTTP/1.1 200 OK"
GET http://localhost:44113/status returned status 200
GET http://localhost:44113/status returned {'status': 'ok'}
Connecting to query engine took 0.1989s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0107s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0142s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 44113
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:44113/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:44113/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:44113/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:44113/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:44113/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1989s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000IM"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:44113/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000IM\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba108ac90 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000IM"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:44113/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000IM\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba108ac90 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_________________________ test_memory_crud_and_search __________________________

    @pytest.mark.asyncio
    async def test_memory_crud_and_search():
        create = MemoryCreate(
            content="Hello world",
            type="short-term",
            userId="u1",
            sessionId="s1",
            metadata={"a": 1},
            keywords=["hello", "greeting"],
            missionId="m1",
            expiresAt=None,
        )
>       m = await MemoryService.create_memory(create)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_memory_service.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/memory_service.py:86: in create_memory
    memory = await db.memory.create(
/usr/local/lib/python3.11/site-packages/prisma/actions.py:2235: in create
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:233: in request
    return self._process_response_data(data=data, response=response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:87: in _process_response_data
    return utils.handle_response_errors(response, errors_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

resp = <Response wrapped=<Response [200 OK]> >
data = [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`", meta:...raint failed on the field: `Memory_missionId_fkey (index)`', 'meta': {'field_name': 'Memory_missionId_fkey (index)'}}}]

    def handle_response_errors(resp: AbstractResponse[Any], data: Any) -> NoReturn:
        for error in data:
            try:
                base_error_message = error.get('error', '')
                user_facing = error.get('user_facing_error', {})
                code = user_facing.get('error_code')
                if code is None:
                    continue
    
                # TODO: the order of these if statements is important because
                # the P2009 code can be returned for both: missing a required value
                # and an unknown field error. As we want to explicitly handle
                # the missing a required value error then we need to check for that first.
                # As we can only check for this error by searching the message then this
                # comes with performance concerns.
                message = user_facing.get('message', '')
    
                if code == 'P2028':
                    if base_error_message.startswith('Transaction already closed'):
                        raise prisma_errors.TransactionExpiredError(base_error_message)
                    raise prisma_errors.TransactionError(message)
    
                if 'A value is required but not set' in message:
                    raise prisma_errors.MissingRequiredValueError(error)
    
                exc: type[Exception] | None = None
    
                kind = user_facing.get('meta', {}).get('kind')
                if kind is not None:
                    exc = META_ERROR_MAPPING.get(kind)
    
                if exc is None:
                    exc = ERROR_MAPPING.get(code)
    
                if exc is not None:
>                   raise exc(error)
E                   prisma.errors.ForeignKeyViolationError: Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`

/usr/local/lib/python3.11/site-packages/prisma/engine/utils.py:175: ForeignKeyViolationError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0065s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0113s
Running query engine on port 40083
Starting query engine...
Constructed GET request to http://localhost:40083/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:06.359046Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:06.389304Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:40083","ip":"127.0.0.1","port":"40083"},"target":"query_engine::server"}
Constructed GET request to http://localhost:40083/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:40083/status "HTTP/1.1 200 OK"
GET http://localhost:40083/status returned status 200
GET http://localhost:40083/status returned {'status': 'ok'}
Connecting to query engine took 0.1749s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0065s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0113s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 40083
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40083/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40083/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:40083/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:40083/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:40083/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1749s
----------------------------- Captured stdout call -----------------------------
[2m2026-02-06T20:04:06.505591Z[0m [[32m[1minfo     [0m] [1mcreating_memory               [0m [36mtype[0m=[35mshort-term[0m [36muser_id[0m=[35mu1[0m
Generated query: 
mutation {
  result: createOneMemory
  (
    data: {
      content: "Hello world"
      type: "short-term"
      userId: "u1"
      sessionId: "s1"
      keywords: [,
        "hello",
        "greeting",
      ]
      missionId: "m1"
      expiresAt: null
      metadata: "{\"a\": 1}"
    }
  )
  {
    id
    content
    type
    userId
    sessionId
    metadata
    keywords
    missionId
    createdAt
    updatedAt
    expiresAt
  }
}
Constructed POST request to http://localhost:40083/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMemory\n  (\n    data: {\n      content: \"Hello world\"\n      type: \"short-term\"\n      userId: \"u1\"\n      sessionId: \"s1\"\n      keywords: [,\n        \"hello\",\n        \"greeting\",\n      ]\n      missionId: \"m1\"\n      expiresAt: null\n      metadata: \"{\\\"a\\\": 1}\"\n    }\n  )\n  {\n    id\n    content\n    type\n    userId\n    sessionId\n    metadata\n    keywords\n    missionId\n    createdAt\n    updatedAt\n    expiresAt\n  }\n}"}
HTTP Request: POST http://localhost:40083/ "HTTP/1.1 200 OK"
POST http://localhost:40083/ returned status 200
POST http://localhost:40083/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`", meta: Object {"field_name": String("Memory_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`', 'meta': {'field_name': 'Memory_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneMemory
  (
    data: {
      content: "Hello world"
      type: "short-term"
      userId: "u1"
      sessionId: "s1"
      keywords: [,
        "hello",
        "greeting",
      ]
      missionId: "m1"
      expiresAt: null
      metadata: "{\"a\": 1}"
    }
  )
  {
    id
    content
    type
    userId
    sessionId
    metadata
    keywords
    missionId
    createdAt
    updatedAt
    expiresAt
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40083/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMemory\n  (\n    data: {\n      content: \"Hello world\"\n      type: \"short-term\"\n      userId: \"u1\"\n      sessionId: \"s1\"\n      keywords: [,\n        \"hello\",\n        \"greeting\",\n      ]\n      missionId: \"m1\"\n      expiresAt: null\n      metadata: \"{\\\"a\\\": 1}\"\n    }\n  )\n  {\n    id\n    content\n    type\n    userId\n    sessionId\n    metadata\n    keywords\n    missionId\n    createdAt\n    updatedAt\n    expiresAt\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40083/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40083/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40083/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`", meta: Object {"field_name": String("Memory_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `Memory_missionId_fkey (index)`', 'meta': {'field_name': 'Memory_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_________________________ test_mission_flow_and_report _________________________

async_client = <httpx.AsyncClient object at 0x744ba28d9610>

    @pytest.mark.asyncio
    async def test_mission_flow_and_report(async_client: AsyncClient):
        create = await async_client.post(
            "/orchestrator/mission",
            json={"title": "Demo", "priority": 10, "payload": {"requirements": {"capabilities": ["backend"]}}},
        )
        assert create.status_code == 200
        mission_id = create.json()["id"]
    
        await async_client.post("/orchestrator/assign")
        await async_client.post(f"/orchestrator/{mission_id}/start")
        await async_client.post(f"/orchestrator/{mission_id}/verify")
        await async_client.post(f"/orchestrator/{mission_id}/complete")
    
        rep = await async_client.post(
            f"/orchestrator/mission/{mission_id}/report",
            json={"agent_id": "agent_test", "overall_project_health": {"composite_score": 70}},
        )
        assert rep.status_code == 200
    
        audit = await async_client.get(f"/orchestrator/{mission_id}/audit")
        assert audit.status_code == 200
        rows = audit.json()
        assert isinstance(rows, list)
>       assert any(r.get("transition") == "report" for r in rows)
E       assert False
E        +  where False = any(<generator object test_mission_flow_and_report.<locals>.<genexpr> at 0x744ba8b4ec00>)

tests/unit/test_mission_flow_report.py:36: AssertionError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0063s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0097s
Running query engine on port 40567
Starting query engine...
Constructed GET request to http://localhost:40567/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:07.992386Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:08.025712Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:40567","ip":"127.0.0.1","port":"40567"},"target":"query_engine::server"}
Constructed GET request to http://localhost:40567/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:40567/status "HTTP/1.1 200 OK"
GET http://localhost:40567/status returned status 200
GET http://localhost:40567/status returned {'status': 'ok'}
Connecting to query engine took 0.1792s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0063s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0097s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 40567
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40567/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40567/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:40567/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:40567/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:40567/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1792s
----------------------------- Captured stdout call -----------------------------
Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      title: "Demo"
      status: "queued"
      userId: "system"
      payload: {
        requirements: {
          capabilities: [,
            "backend",
          ]
        }
      }
      createdAt: "2026-02-06T20:04:08.154000+00:00"
      updatedAt: "2026-02-06T20:04:08.154000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      title: \"Demo\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        requirements: {\n          capabilities: [,\n            \"backend\",\n          ]\n        }\n      }\n      createdAt: \"2026-02-06T20:04:08.154000+00:00\"\n      updatedAt: \"2026-02-06T20:04:08.154000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'Error in query graph construction: QueryParserError(ValidationError { kind: Union, message: "Unable to match input value to any allowed input type for the field. Parse errors: [`data.user`: A value is required but not set, Unable to match input value to any allowed input type for the field. Parse errors: [Invalid argument type. `payload` should be of any of the following types: `NullableJsonNullValueInput`, Invalid argument type. `payload` should be of any of the following types: `Json`]]", meta: Some(Object {"errors": Array [Object {"kind": String("RequiredArgumentMissing"), "inputTypes": Array [Object {"kind": String("object"), "name": String("UserCreateNestedOneWithoutMissionsInput"), "fields": Array [Object {"name": String("create"), "typeNames": Array [String("UserCreateWithoutMissionsInput"), String("UserUncheckedCreateWithoutMissionsInput")], "required": Bool(false)}, Object {"name": String("connectOrCreate"), "typeNames": Array [String("UserCreateOrConnectWithoutMissionsInput")], "required": Bool(false)}, Object {"name": String("connect"), "typeNames": Array [String("UserWhereUniqueInput")], "required": Bool(false)}]}], "argumentPath": Array [String("data"), String("user")], "selectionPath": Array [String("createOneMission")]}, Object {"kind": String("Union"), "errors": Array [Object {"kind": String("InvalidArgumentType"), "argumentPath": Array [String("data"), String("payload")], "argument": Object {"name": String("payload"), "typeNames": Array [String("NullableJsonNullValueInput")]}, "selectionPath": Array [String("createOneMission")], "inferredType": String("Object")}, Object {"kind": String("InvalidArgumentType"), "argumentPath": Array [String("data"), String("payload")], "argument": Object {"name": String("payload"), "typeNames": Array [String("Json")]}, "selectionPath": Array [String("createOneMission")], "inferredType": String("Object")}]}]}) })', 'user_facing_error': {'is_panic': False, 'message': 'Unable to match input value to any allowed input type for the field. Parse errors: [`data.user`: A value is required but not set, Unable to match input value to any allowed input type for the field. Parse errors: [Invalid argument type. `payload` should be of any of the following types: `NullableJsonNullValueInput`, Invalid argument type. `payload` should be of any of the following types: `Json`]]', 'meta': {'kind': 'Union', 'errors': [{'kind': 'RequiredArgumentMissing', 'inputTypes': [{'kind': 'object', 'name': 'UserCreateNestedOneWithoutMissionsInput', 'fields': [{'name': 'create', 'typeNames': ['UserCreateWithoutMissionsInput', 'UserUncheckedCreateWithoutMissionsInput'], 'required': False}, {'name': 'connectOrCreate', 'typeNames': ['UserCreateOrConnectWithoutMissionsInput'], 'required': False}, {'name': 'connect', 'typeNames': ['UserWhereUniqueInput'], 'required': False}]}], 'argumentPath': ['data', 'user'], 'selectionPath': ['createOneMission']}, {'kind': 'Union', 'errors': [{'kind': 'InvalidArgumentType', 'argumentPath': ['data', 'payload'], 'argument': {'name': 'payload', 'typeNames': ['NullableJsonNullValueInput']}, 'selectionPath': ['createOneMission'], 'inferredType': 'Object'}, {'kind': 'InvalidArgumentType', 'argumentPath': ['data', 'payload'], 'argument': {'name': 'payload', 'typeNames': ['Json']}, 'selectionPath': ['createOneMission'], 'inferredType': 'Object'}]}]}, 'error_code': 'P2009'}}]}
[2m2026-02-06T20:04:08.175022Z[0m [[31m[1merror    [0m] [1mPersistence failed for mission 7cbfed3d-419c-4c93-9ab1-3787f6580134: Unable to match input value to any allowed input type for the field. Parse errors: [`data.user`: A value is required but not set, Unable to match input value to any allowed input type for the field. Parse errors: [Invalid argument type. `payload` should be of any of the following types: `NullableJsonNullValueInput`, Invalid argument type. `payload` should be of any of the following types: `Json`]][0m
HTTP Request: POST http://test/orchestrator/mission "HTTP/1.1 200 OK"
Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'data': {'result': []}}
Generated query: 
query {
  result: findManyAgent
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'data': {'result': [{'id': '75a272fd-0dc9-4c40-a5b8-ac29a3864eaa', 'name': 'qa-engineer', 'role': 'qa engineer', 'version': '1.0.0', 'capabilities': ['test automation', 'playwright', 'pytest', 'e2e testing', 'quality assurance'], 'topics': ['agent.events'], 'healthUrl': 'http://qa-engineer:8005/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.338Z', 'createdAt': '2026-02-06T10:34:42.130Z', 'updatedAt': '2026-02-06T14:46:37.723Z', 'dedupKey': 'qa-engineer'}, {'id': 'dd752a91-4ebd-4551-977e-7b7a30446176', 'name': 'devops-engineer', 'role': 'devops engineer', 'version': '1.0.0', 'capabilities': ['docker', 'kubernetes', 'ci/cd', 'infrastructure as code', 'monitoring'], 'topics': ['agent.events'], 'healthUrl': 'http://devops-engineer:8006/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.432Z', 'createdAt': '2026-02-06T10:34:41.877Z', 'updatedAt': '2026-02-06T14:46:37.733Z', 'dedupKey': 'devops-engineer'}, {'id': '38e1566e-5731-4010-8225-f69dead8e493', 'name': 'project-strategist', 'role': 'project strategist', 'version': '1.0.0', 'capabilities': ['task planning', 'delegation', 'project management', 'coordination'], 'topics': ['agent.events'], 'healthUrl': 'http://project-strategist:8001/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.533Z', 'createdAt': '2026-02-06T10:34:40.845Z', 'updatedAt': '2026-02-06T14:46:37.744Z', 'dedupKey': 'project-strategist'}, {'id': '110e99bf-c17c-4d2e-bf92-1306131cfd96', 'name': 'system-architect', 'role': 'system architect', 'version': '1.0.0', 'capabilities': ['system design', 'architecture patterns', 'scalability', 'api design', 'technical strategy'], 'topics': ['agent.events'], 'healthUrl': 'http://system-architect:8008/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.560Z', 'createdAt': '2026-02-06T10:34:40.629Z', 'updatedAt': '2026-02-06T14:46:37.753Z', 'dedupKey': 'system-architect'}, {'id': '62173b75-cd92-44e9-bb22-50d1e00df5cb', 'name': 'security-engineer', 'role': 'security engineer', 'version': '1.0.0', 'capabilities': ['security auditing', 'owasp', 'vulnerability scanning', 'secure coding', 'compliance'], 'topics': ['agent.events'], 'healthUrl': 'http://security-engineer:8007/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.548Z', 'createdAt': '2026-02-06T10:34:42.220Z', 'updatedAt': '2026-02-06T14:46:37.762Z', 'dedupKey': 'security-engineer'}, {'id': '801f7672-5783-4b87-a07c-d2921d3cff86', 'name': 'backend-specialist', 'role': 'backend specialist', 'version': '1.0.0', 'capabilities': ['fastapi', 'python', 'rest apis', 'business logic', 'authentication'], 'topics': ['agent.events'], 'healthUrl': 'http://backend-specialist:8003/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.119Z', 'createdAt': '2026-02-06T10:34:41.948Z', 'updatedAt': '2026-02-06T14:46:37.685Z', 'dedupKey': 'backend-specialist'}, {'id': '41e079dc-9c2d-4a6f-b0bc-10ac1f9cacef', 'name': 'frontend-specialist', 'role': 'frontend specialist', 'version': '1.0.0', 'capabilities': ['react', 'next.js', 'typescript', 'tailwind css', 'ui/ux'], 'topics': ['agent.events'], 'healthUrl': 'http://frontend-specialist:8002/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.173Z', 'createdAt': '2026-02-06T10:34:39.788Z', 'updatedAt': '2026-02-06T14:46:37.702Z', 'dedupKey': 'frontend-specialist'}, {'id': 'adaba92e-197d-4e98-beeb-d828c23db2ec', 'name': 'database-architect', 'role': 'database architect', 'version': '1.0.0', 'capabilities': ['postgresql', 'schema design', 'query optimization', 'migrations', 'indexing'], 'topics': ['agent.events'], 'healthUrl': 'http://database-architect:8004/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.192Z', 'createdAt': '2026-02-06T10:34:41.621Z', 'updatedAt': '2026-02-06T14:46:37.713Z', 'dedupKey': 'database-architect'}, {'id': 'ba66a3e1-c897-4f7b-87c4-24a343165a84', 'name': 'Lifecycle Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': ['c'], 'topics': ['t'], 'healthUrl': 'http://localhost', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:56.494Z', 'createdAt': '2026-02-06T20:03:56.361Z', 'updatedAt': '2026-02-06T20:03:56.534Z', 'dedupKey': '00000000-0000-0000-0000-00000000LC'}, {'id': '048c7018-a3f5-4cde-a6f0-807b57a04119', 'name': 'Idem Agent', 'role': 'worker', 'version': '0.2.0', 'capabilities': ['compute'], 'topics': ['agent.events'], 'healthUrl': 'http://localhost:5001/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:38.083Z', 'createdAt': '2026-02-06T20:03:38.006Z', 'updatedAt': '2026-02-06T20:03:57.010Z', 'dedupKey': '00000000-0000-0000-0000-000000000001'}, {'id': '57729d2b-1662-41c6-8b47-88fd5f90e964', 'name': 'Test Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': ['compute'], 'topics': ['agent.events'], 'healthUrl': 'http://localhost:5000/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:39.351Z', 'createdAt': '2026-02-06T20:03:38.634Z', 'updatedAt': '2026-02-06T20:03:57.034Z', 'dedupKey': '00000000-0000-0000-0000-00000000TA'}, {'id': '9615429e-1df1-45b3-bbab-9e781b070d61', 'name': 'Timeout Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': [], 'topics': [], 'healthUrl': None, 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:56.928Z', 'createdAt': '2026-02-06T20:03:56.941Z', 'updatedAt': '2026-02-06T20:03:57.063Z', 'dedupKey': '00000000-0000-0000-0000-00000000TO'}]}}
Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'data': {'result': []}}
HTTP Request: POST http://test/orchestrator/assign "HTTP/1.1 204 No Content"
Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "executing"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"executing\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "queued"
      newState: "executing"
      actor: "orchestrator"
      reason: "Transition to executing"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"queued\"\n      newState: \"executing\"\n      actor: \"orchestrator\"\n      reason: \"Transition to executing\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
[2m2026-02-06T20:04:08.338158Z[0m [[31m[1merror    [0m] [1mPersistence failed for transition 7cbfed3d-419c-4c93-9ab1-3787f6580134: Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`[0m
HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/start "HTTP/1.1 200 OK"
Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "verifying"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"verifying\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "executing"
      newState: "verifying"
      actor: "orchestrator"
      reason: "Transition to verifying"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"executing\"\n      newState: \"verifying\"\n      actor: \"orchestrator\"\n      reason: \"Transition to verifying\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
[2m2026-02-06T20:04:08.404611Z[0m [[31m[1merror    [0m] [1mPersistence failed for transition 7cbfed3d-419c-4c93-9ab1-3787f6580134: Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`[0m
HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/verify "HTTP/1.1 200 OK"
Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "completed"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"completed\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "verifying"
      newState: "completed"
      actor: "orchestrator"
      reason: "Transition to completed"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"verifying\"\n      newState: \"completed\"\n      actor: \"orchestrator\"\n      reason: \"Transition to completed\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
[2m2026-02-06T20:04:08.470256Z[0m [[31m[1merror    [0m] [1mPersistence failed for transition 7cbfed3d-419c-4c93-9ab1-3787f6580134: Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`[0m
HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/complete "HTTP/1.1 200 OK"
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
HTTP Request: POST http://test/orchestrator/mission/7cbfed3d-419c-4c93-9ab1-3787f6580134/report "HTTP/1.1 200 OK"
Generated query: 
query {
  result: findManyAuditLog
  (
    where: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
    orderBy: {
      timestamp: "asc"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
Constructed POST request to http://localhost:40567/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAuditLog\n  (\n    where: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n    orderBy: {\n      timestamp: \"asc\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
POST http://localhost:40567/ returned status 200
POST http://localhost:40567/ returned {'data': {'result': []}}
HTTP Request: GET http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/audit "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      title: "Demo"
      status: "queued"
      userId: "system"
      payload: {
        requirements: {
          capabilities: [,
            "backend",
          ]
        }
      }
      createdAt: "2026-02-06T20:04:08.154000+00:00"
      updatedAt: "2026-02-06T20:04:08.154000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      title: \"Demo\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        requirements: {\n          capabilities: [,\n            \"backend\",\n          ]\n        }\n      }\n      createdAt: \"2026-02-06T20:04:08.154000+00:00\"\n      updatedAt: \"2026-02-06T20:04:08.154000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'Error in query graph construction: QueryParserError(ValidationError { kind: Union, message: "Unable to match input value to any allowed input type for the field. Parse errors: [`data.user`: A value is required but not set, Unable to match input value to any allowed input type for the field. Parse errors: [Invalid argument type. `payload` should be of any of the following types: `NullableJsonNullValueInput`, Invalid argument type. `payload` should be of any of the following types: `Json`]]", meta: Some(Object {"errors": Array [Object {"kind": String("RequiredArgumentMissing"), "inputTypes": Array [Object {"kind": String("object"), "name": String("UserCreateNestedOneWithoutMissionsInput"), "fields": Array [Object {"name": String("create"), "typeNames": Array [String("UserCreateWithoutMissionsInput"), String("UserUncheckedCreateWithoutMissionsInput")], "required": Bool(false)}, Object {"name": String("connectOrCreate"), "typeNames": Array [String("UserCreateOrConnectWithoutMissionsInput")], "required": Bool(false)}, Object {"name": String("connect"), "typeNames": Array [String("UserWhereUniqueInput")], "required": Bool(false)}]}], "argumentPath": Array [String("data"), String("user")], "selectionPath": Array [String("createOneMission")]}, Object {"kind": String("Union"), "errors": Array [Object {"kind": String("InvalidArgumentType"), "argumentPath": Array [String("data"), String("payload")], "argument": Object {"name": String("payload"), "typeNames": Array [String("NullableJsonNullValueInput")]}, "selectionPath": Array [String("createOneMission")], "inferredType": String("Object")}, Object {"kind": String("InvalidArgumentType"), "argumentPath": Array [String("data"), String("payload")], "argument": Object {"name": String("payload"), "typeNames": Array [String("Json")]}, "selectionPath": Array [String("createOneMission")], "inferredType": String("Object")}]}]}) })', 'user_facing_error': {'is_panic': False, 'message': 'Unable to match input value to any allowed input type for the field. Parse errors: [`data.user`: A value is required but not set, Unable to match input value to any allowed input type for the field. Parse errors: [Invalid argument type. `payload` should be of any of the following types: `NullableJsonNullValueInput`, Invalid argument type. `payload` should be of any of the following types: `Json`]]', 'meta': {'kind': 'Union', 'errors': [{'kind': 'RequiredArgumentMissing', 'inputTypes': [{'kind': 'object', 'name': 'UserCreateNestedOneWithoutMissionsInput', 'fields': [{'name': 'create', 'typeNames': ['UserCreateWithoutMissionsInput', 'UserUncheckedCreateWithoutMissionsInput'], 'required': False}, {'name': 'connectOrCreate', 'typeNames': ['UserCreateOrConnectWithoutMissionsInput'], 'required': False}, {'name': 'connect', 'typeNames': ['UserWhereUniqueInput'], 'required': False}]}], 'argumentPath': ['data', 'user'], 'selectionPath': ['createOneMission']}, {'kind': 'Union', 'errors': [{'kind': 'InvalidArgumentType', 'argumentPath': ['data', 'payload'], 'argument': {'name': 'payload', 'typeNames': ['NullableJsonNullValueInput']}, 'selectionPath': ['createOneMission'], 'inferredType': 'Object'}, {'kind': 'InvalidArgumentType', 'argumentPath': ['data', 'payload'], 'argument': {'name': 'payload', 'typeNames': ['Json']}, 'selectionPath': ['createOneMission'], 'inferredType': 'Object'}]}]}, 'error_code': 'P2009'}}]}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/mission "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'data': {'result': []}}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findManyAgent
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'data': {'result': [{'id': '75a272fd-0dc9-4c40-a5b8-ac29a3864eaa', 'name': 'qa-engineer', 'role': 'qa engineer', 'version': '1.0.0', 'capabilities': ['test automation', 'playwright', 'pytest', 'e2e testing', 'quality assurance'], 'topics': ['agent.events'], 'healthUrl': 'http://qa-engineer:8005/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.338Z', 'createdAt': '2026-02-06T10:34:42.130Z', 'updatedAt': '2026-02-06T14:46:37.723Z', 'dedupKey': 'qa-engineer'}, {'id': 'dd752a91-4ebd-4551-977e-7b7a30446176', 'name': 'devops-engineer', 'role': 'devops engineer', 'version': '1.0.0', 'capabilities': ['docker', 'kubernetes', 'ci/cd', 'infrastructure as code', 'monitoring'], 'topics': ['agent.events'], 'healthUrl': 'http://devops-engineer:8006/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.432Z', 'createdAt': '2026-02-06T10:34:41.877Z', 'updatedAt': '2026-02-06T14:46:37.733Z', 'dedupKey': 'devops-engineer'}, {'id': '38e1566e-5731-4010-8225-f69dead8e493', 'name': 'project-strategist', 'role': 'project strategist', 'version': '1.0.0', 'capabilities': ['task planning', 'delegation', 'project management', 'coordination'], 'topics': ['agent.events'], 'healthUrl': 'http://project-strategist:8001/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.533Z', 'createdAt': '2026-02-06T10:34:40.845Z', 'updatedAt': '2026-02-06T14:46:37.744Z', 'dedupKey': 'project-strategist'}, {'id': '110e99bf-c17c-4d2e-bf92-1306131cfd96', 'name': 'system-architect', 'role': 'system architect', 'version': '1.0.0', 'capabilities': ['system design', 'architecture patterns', 'scalability', 'api design', 'technical strategy'], 'topics': ['agent.events'], 'healthUrl': 'http://system-architect:8008/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.560Z', 'createdAt': '2026-02-06T10:34:40.629Z', 'updatedAt': '2026-02-06T14:46:37.753Z', 'dedupKey': 'system-architect'}, {'id': '62173b75-cd92-44e9-bb22-50d1e00df5cb', 'name': 'security-engineer', 'role': 'security engineer', 'version': '1.0.0', 'capabilities': ['security auditing', 'owasp', 'vulnerability scanning', 'secure coding', 'compliance'], 'topics': ['agent.events'], 'healthUrl': 'http://security-engineer:8007/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.548Z', 'createdAt': '2026-02-06T10:34:42.220Z', 'updatedAt': '2026-02-06T14:46:37.762Z', 'dedupKey': 'security-engineer'}, {'id': '801f7672-5783-4b87-a07c-d2921d3cff86', 'name': 'backend-specialist', 'role': 'backend specialist', 'version': '1.0.0', 'capabilities': ['fastapi', 'python', 'rest apis', 'business logic', 'authentication'], 'topics': ['agent.events'], 'healthUrl': 'http://backend-specialist:8003/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.119Z', 'createdAt': '2026-02-06T10:34:41.948Z', 'updatedAt': '2026-02-06T14:46:37.685Z', 'dedupKey': 'backend-specialist'}, {'id': '41e079dc-9c2d-4a6f-b0bc-10ac1f9cacef', 'name': 'frontend-specialist', 'role': 'frontend specialist', 'version': '1.0.0', 'capabilities': ['react', 'next.js', 'typescript', 'tailwind css', 'ui/ux'], 'topics': ['agent.events'], 'healthUrl': 'http://frontend-specialist:8002/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.173Z', 'createdAt': '2026-02-06T10:34:39.788Z', 'updatedAt': '2026-02-06T14:46:37.702Z', 'dedupKey': 'frontend-specialist'}, {'id': 'adaba92e-197d-4e98-beeb-d828c23db2ec', 'name': 'database-architect', 'role': 'database architect', 'version': '1.0.0', 'capabilities': ['postgresql', 'schema design', 'query optimization', 'migrations', 'indexing'], 'topics': ['agent.events'], 'healthUrl': 'http://database-architect:8004/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T14:45:20.192Z', 'createdAt': '2026-02-06T10:34:41.621Z', 'updatedAt': '2026-02-06T14:46:37.713Z', 'dedupKey': 'database-architect'}, {'id': 'ba66a3e1-c897-4f7b-87c4-24a343165a84', 'name': 'Lifecycle Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': ['c'], 'topics': ['t'], 'healthUrl': 'http://localhost', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:56.494Z', 'createdAt': '2026-02-06T20:03:56.361Z', 'updatedAt': '2026-02-06T20:03:56.534Z', 'dedupKey': '00000000-0000-0000-0000-00000000LC'}, {'id': '048c7018-a3f5-4cde-a6f0-807b57a04119', 'name': 'Idem Agent', 'role': 'worker', 'version': '0.2.0', 'capabilities': ['compute'], 'topics': ['agent.events'], 'healthUrl': 'http://localhost:5001/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:38.083Z', 'createdAt': '2026-02-06T20:03:38.006Z', 'updatedAt': '2026-02-06T20:03:57.010Z', 'dedupKey': '00000000-0000-0000-0000-000000000001'}, {'id': '57729d2b-1662-41c6-8b47-88fd5f90e964', 'name': 'Test Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': ['compute'], 'topics': ['agent.events'], 'healthUrl': 'http://localhost:5000/health', 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:39.351Z', 'createdAt': '2026-02-06T20:03:38.634Z', 'updatedAt': '2026-02-06T20:03:57.034Z', 'dedupKey': '00000000-0000-0000-0000-00000000TA'}, {'id': '9615429e-1df1-45b3-bbab-9e781b070d61', 'name': 'Timeout Agent', 'role': 'worker', 'version': '0.1.0', 'capabilities': [], 'topics': [], 'healthUrl': None, 'status': 'offline', 'lastHeartbeat': '2026-02-06T20:03:56.928Z', 'createdAt': '2026-02-06T20:03:56.941Z', 'updatedAt': '2026-02-06T20:03:57.063Z', 'dedupKey': '00000000-0000-0000-0000-00000000TO'}]}}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'data': {'result': []}}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/assign "HTTP/1.1 204 No Content"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "executing"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"executing\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "queued"
      newState: "executing"
      actor: "orchestrator"
      reason: "Transition to executing"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"queued\"\n      newState: \"executing\"\n      actor: \"orchestrator\"\n      reason: \"Transition to executing\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/start "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "verifying"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"verifying\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "executing"
      newState: "verifying"
      actor: "orchestrator"
      reason: "Transition to verifying"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"executing\"\n      newState: \"verifying\"\n      actor: \"orchestrator\"\n      reason: \"Transition to verifying\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/verify "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: updateOneMission
  (
    data: {
      status: "completed"
    }
    where: {
      id: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: updateOneMission\n  (\n    data: {\n      status: \"completed\"\n    }\n    where: {\n      id: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'Error occurred during query execution:\nInterpretationError("Error for binding \'0\'", Some(QueryGraphBuilderError(RecordNotFound("Record to update not found."))))', 'user_facing_error': {'is_panic': False, 'message': 'An operation failed because it depends on one or more records that were required but not found. Record to update not found.', 'meta': {'cause': 'Record to update not found.'}, 'error_code': 'P2025'}}]}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "update"
      previousState: "verifying"
      newState: "completed"
      actor: "orchestrator"
      reason: "Transition to completed"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"update\"\n      previousState: \"verifying\"\n      newState: \"completed\"\n      actor: \"orchestrator\"\n      reason: \"Transition to completed\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/complete "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAuditLog
  (
    data: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
      transition: "report"
      previousState: "n/a"
      newState: "n/a"
      actor: "agent_test"
      reason: "Health check report submitted"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAuditLog\n  (\n    data: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n      transition: \"report\"\n      previousState: \"n/a\"\n      newState: \"n/a\"\n      actor: \"agent_test\"\n      reason: \"Health check report submitted\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'errors': [{'error': 'KnownError { message: "Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`", meta: Object {"field_name": String("AuditLog_missionId_fkey (index)")}, error_code: "P2003" }', 'user_facing_error': {'is_panic': False, 'message': 'Foreign key constraint failed on the field: `AuditLog_missionId_fkey (index)`', 'meta': {'field_name': 'AuditLog_missionId_fkey (index)'}, 'error_code': 'P2003'}}]}
INFO     httpx:_client.py:1758 HTTP Request: POST http://test/orchestrator/mission/7cbfed3d-419c-4c93-9ab1-3787f6580134/report "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findManyAuditLog
  (
    where: {
      missionId: "7cbfed3d-419c-4c93-9ab1-3787f6580134"
    }
    orderBy: {
      timestamp: "asc"
    }
  )
  {
    id
    missionId
    transition
    previousState
    newState
    actor
    timestamp
    reason
    diff
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40567/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAuditLog\n  (\n    where: {\n      missionId: \"7cbfed3d-419c-4c93-9ab1-3787f6580134\"\n    }\n    orderBy: {\n      timestamp: \"asc\"\n    }\n  )\n  {\n    id\n    missionId\n    transition\n    previousState\n    newState\n    actor\n    timestamp\n    reason\n    diff\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:40567/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:40567/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:40567/ returned {'data': {'result': []}}
INFO     httpx:_client.py:1758 HTTP Request: GET http://test/orchestrator/7cbfed3d-419c-4c93-9ab1-3787f6580134/audit "HTTP/1.1 200 OK"
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_________________________ test_mission_full_lifecycle __________________________

    @pytest.mark.asyncio
    async def test_mission_full_lifecycle():
        # Mock EventBus
        with patch.object(event_bus, "publish_stream", new_callable=AsyncMock) as mock_publish:
            mock_publish.return_value = "1-0" # Mock entry ID
    
            # 1. Submit
            req = {"title": "Lifecycle Mission", "priority": 80, "payload": {"foo": "bar"}}
            r = client.post("/orchestrator/mission", json=req)
            assert r.status_code == 200
            mid = r.json()["id"]
            assert r.json()["state"] == "queued"
    
            # Verify Create Event
            assert mock_publish.call_count == 1
            args, _ = mock_publish.call_args
            assert args[0] == "mission.events"
            assert args[1].message_type == "mission.created"
    
            # 2. Assign (need an agent first)
            # Register agent
            agent_data = {
                "name": "Test Agent",
                "role": "worker",
                "capabilities": ["foo"],
                "topics": [],
                "health_url": "http://localhost",
                "dedup_key": "unique-lifecycle-key"
            }
            client.post("/agents/register", json=agent_data)
    
            # Assign
>           r = client.post("/orchestrator/assign")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_mission_lifecycle.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/orchestrator.py:28: in assign_next
    res = await orchestrator.assign_next()
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/orchestrator.py:140: in assign_next
    agents = await agent_registry.list_agents()
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:213: in list_agents
    agents = await db.agent.find_many(
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4593: in find_many
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:135: in handle_async_request
    await self._response_closed()
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:250: in _response_closed
    await self.aclose()
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:258: in aclose
    await self._network_stream.aclose()
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:53: in aclose
    await self._stream.aclose()
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1329: in aclose
    self._transport.close()
/usr/local/lib/python3.11/asyncio/selector_events.py:864: in close
    self._loop.call_soon(self._call_connection_lost, None)
/usr/local/lib/python3.11/asyncio/base_events.py:762: in call_soon
    self._check_closed()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=True debug=False>

    def _check_closed(self):
        if self._closed:
>           raise RuntimeError('Event loop is closed')
E           RuntimeError: Event loop is closed

/usr/local/lib/python3.11/asyncio/base_events.py:520: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0088s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0245s
Running query engine on port 33009
Starting query engine...
Constructed GET request to http://localhost:33009/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:09.728935Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:09.772920Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:33009","ip":"127.0.0.1","port":"33009"},"target":"query_engine::server"}
Constructed GET request to http://localhost:33009/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:33009/status "HTTP/1.1 200 OK"
GET http://localhost:33009/status returned status 200
GET http://localhost:33009/status returned {'status': 'ok'}
Connecting to query engine took 0.2342s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0088s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0245s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 33009
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:33009/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:33009/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:33009/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:33009/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:33009/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.2342s
----------------------------- Captured stdout call -----------------------------
Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "2577242d-5feb-4998-b815-69894e0f352c"
      title: "Lifecycle Mission"
      status: "queued"
      userId: "system"
      payload: {
        foo: "bar"
      }
      createdAt: "2026-02-06T20:04:09.932000+00:00"
      updatedAt: "2026-02-06T20:04:09.932000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
Constructed POST request to http://localhost:33009/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"2577242d-5feb-4998-b815-69894e0f352c\"\n      title: \"Lifecycle Mission\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        foo: \"bar\"\n      }\n      createdAt: \"2026-02-06T20:04:09.932000+00:00\"\n      updatedAt: \"2026-02-06T20:04:09.932000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
[2m2026-02-06T20:04:09.953396Z[0m [[31m[1merror    [0m] [1mPersistence failed for mission 2577242d-5feb-4998-b815-69894e0f352c: <asyncio.locks.Event object at 0x744ba0e2ee90 [unset]> is bound to a different event loop[0m
HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "unique-lifecycle-key"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:33009/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"unique-lifecycle-key\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
HTTP Request: POST http://localhost:33009/ "HTTP/1.1 200 OK"
POST http://localhost:33009/ returned status 200
POST http://localhost:33009/ returned {'data': {'result': None}}
Generated query: 
mutation {
  result: createOneAgent
  (
    data: {
      id: "ef83b048-f776-4aae-9ebd-3160c9e00fac"
      name: "Test Agent"
      role: "worker"
      version: "1.0.0"
      capabilities: [,
        "foo",
      ]
      topics: [,
      ]
      healthUrl: "http://localhost"
      status: "active"
      lastHeartbeat: "2026-02-06T20:04:10.076000+00:00"
      dedupKey: "unique-lifecycle-key"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:33009/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAgent\n  (\n    data: {\n      id: \"ef83b048-f776-4aae-9ebd-3160c9e00fac\"\n      name: \"Test Agent\"\n      role: \"worker\"\n      version: \"1.0.0\"\n      capabilities: [,\n        \"foo\",\n      ]\n      topics: [,\n      ]\n      healthUrl: \"http://localhost\"\n      status: \"active\"\n      lastHeartbeat: \"2026-02-06T20:04:10.076000+00:00\"\n      dedupKey: \"unique-lifecycle-key\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
HTTP Request: POST http://localhost:33009/ "HTTP/1.1 200 OK"
POST http://localhost:33009/ returned status 200
POST http://localhost:33009/ returned {'data': {'result': {'id': 'ef83b048-f776-4aae-9ebd-3160c9e00fac', 'name': 'Test Agent', 'role': 'worker', 'version': '1.0.0', 'capabilities': ['foo'], 'topics': [], 'healthUrl': 'http://localhost', 'status': 'active', 'lastHeartbeat': '2026-02-06T20:04:10.076Z', 'createdAt': '2026-02-06T20:04:10.092Z', 'updatedAt': '2026-02-06T20:04:10.092Z', 'dedupKey': 'unique-lifecycle-key'}}}
Registered agent: Test Agent (ef83b048-f776-4aae-9ebd-3160c9e00fac)
HTTP Request: POST http://testserver/agents/register "HTTP/1.1 200 OK"
Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:33009/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneMission
  (
    data: {
      id: "2577242d-5feb-4998-b815-69894e0f352c"
      title: "Lifecycle Mission"
      status: "queued"
      userId: "system"
      payload: {
        foo: "bar"
      }
      createdAt: "2026-02-06T20:04:09.932000+00:00"
      updatedAt: "2026-02-06T20:04:09.932000+00:00"
    }
  )
  {
    id
    title
    status
    agentId
    userId
    createdAt
    updatedAt
    completedAt
    retryCount
    maxRetries
    payload
    metadata
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:33009/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneMission\n  (\n    data: {\n      id: \"2577242d-5feb-4998-b815-69894e0f352c\"\n      title: \"Lifecycle Mission\"\n      status: \"queued\"\n      userId: \"system\"\n      payload: {\n        foo: \"bar\"\n      }\n      createdAt: \"2026-02-06T20:04:09.932000+00:00\"\n      updatedAt: \"2026-02-06T20:04:09.932000+00:00\"\n    }\n  )\n  {\n    id\n    title\n    status\n    agentId\n    userId\n    createdAt\n    updatedAt\n    completedAt\n    retryCount\n    maxRetries\n    payload\n    metadata\n  }\n}"}
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/orchestrator/mission "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "unique-lifecycle-key"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:33009/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"unique-lifecycle-key\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:33009/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:33009/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:33009/ returned {'data': {'result': None}}
DEBUG    prisma._builder:_builder.py:189 Generated query: 
mutation {
  result: createOneAgent
  (
    data: {
      id: "ef83b048-f776-4aae-9ebd-3160c9e00fac"
      name: "Test Agent"
      role: "worker"
      version: "1.0.0"
      capabilities: [,
        "foo",
      ]
      topics: [,
      ]
      healthUrl: "http://localhost"
      status: "active"
      lastHeartbeat: "2026-02-06T20:04:10.076000+00:00"
      dedupKey: "unique-lifecycle-key"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:33009/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "mutation", "query": "mutation {\n  result: createOneAgent\n  (\n    data: {\n      id: \"ef83b048-f776-4aae-9ebd-3160c9e00fac\"\n      name: \"Test Agent\"\n      role: \"worker\"\n      version: \"1.0.0\"\n      capabilities: [,\n        \"foo\",\n      ]\n      topics: [,\n      ]\n      healthUrl: \"http://localhost\"\n      status: \"active\"\n      lastHeartbeat: \"2026-02-06T20:04:10.076000+00:00\"\n      dedupKey: \"unique-lifecycle-key\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
INFO     httpx:_client.py:1758 HTTP Request: POST http://localhost:33009/ "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 POST http://localhost:33009/ returned status 200
DEBUG    prisma.engine._http:_http.py:231 POST http://localhost:33009/ returned {'data': {'result': {'id': 'ef83b048-f776-4aae-9ebd-3160c9e00fac', 'name': 'Test Agent', 'role': 'worker', 'version': '1.0.0', 'capabilities': ['foo'], 'topics': [], 'healthUrl': 'http://localhost', 'status': 'active', 'lastHeartbeat': '2026-02-06T20:04:10.076Z', 'createdAt': '2026-02-06T20:04:10.092Z', 'updatedAt': '2026-02-06T20:04:10.092Z', 'dedupKey': 'unique-lifecycle-key'}}}
INFO     app.services.agent_registry:agent_registry.py:154 Registered agent: Test Agent (ef83b048-f776-4aae-9ebd-3160c9e00fac)
INFO     httpx:_client.py:1027 HTTP Request: POST http://testserver/agents/register "HTTP/1.1 200 OK"
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findManyAgent
  (
    where: {
      status: {
        not: "offline"
      }
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:33009/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findManyAgent\n  (\n    where: {\n      status: {\n        not: \"offline\"\n      }\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
____________ test_orchestrator_assign_prefers_capability_and_health ____________

    def test_orchestrator_assign_prefers_capability_and_health():
        # Override auth to allow access
        app.dependency_overrides[get_current_user] = lambda: {
            "sub": "test-user",
            "scopes": ["mission:write", "mission:read", "mission:assign"]
        }
        client = TestClient(app)
        # Register two agents: one with gpu capability, one without
        a1 = {
            "name": "Worker NoGPU",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5004/health",
            "dedup_key": "00000000-0000-0000-0000-00000000NG",
        }
        a2 = {
            "name": "Worker GPU",
            "role": "worker",
            "version": "0.1.0",
            "capabilities": ["compute", "gpu"],
            "topics": ["agent.events"],
            "health_url": "http://localhost:5005/health",
            "dedup_key": "00000000-0000-0000-0000-00000000GP",
        }
>       r1 = client.post("/agents/register", json=a1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_orchestrator_selection.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba10b9710 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba10b9710 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.007s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0145s
Running query engine on port 60177
Starting query engine...
Constructed GET request to http://localhost:60177/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:16.576459Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:16.606833Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:60177","ip":"127.0.0.1","port":"60177"},"target":"query_engine::server"}
Constructed GET request to http://localhost:60177/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:60177/status "HTTP/1.1 200 OK"
GET http://localhost:60177/status returned status 200
GET http://localhost:60177/status returned {'status': 'ok'}
Connecting to query engine took 0.1822s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.007s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0145s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 60177
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:60177/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:60177/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:60177/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:60177/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:60177/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1822s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000NG"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:60177/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000NG\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba10b9710 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000NG"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:60177/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000NG\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba10b9710 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_______________________ test_rate_limiter_redis_allowed ________________________

self = <app.middleware.rate_limit.RateLimiter object at 0x744ba0dcfa10>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
>               RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                ^^^^^^^^^^^^^^^^^
E               NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:55: NameError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_rate_limiter_redis_allowed():
        limiter = RateLimiter()
        limiter._redis = AsyncMock()
        limiter._script = AsyncMock(return_value=1) # Lua returns 1 for allowed
    
>       allowed = await limiter.check("test_key", 10, 60)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x744ba0dcfa10>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
                RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                if not allowed:
                    RATE_LIMIT_HITS.labels(scope=scope).inc()
                return allowed
            except Exception as e:
                logger.error(f"Redis rate limit error: {e}")
>               REDIS_ERRORS.inc()
                ^^^^^^^^^^^^
E               NameError: name 'REDIS_ERRORS' is not defined

app/middleware/rate_limit.py:61: NameError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0104s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0142s
Running query engine on port 39885
Starting query engine...
Constructed GET request to http://localhost:39885/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:21.664366Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:21.694750Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:39885","ip":"127.0.0.1","port":"39885"},"target":"query_engine::server"}
Constructed GET request to http://localhost:39885/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:39885/status "HTTP/1.1 200 OK"
GET http://localhost:39885/status returned status 200
GET http://localhost:39885/status returned {'status': 'ok'}
Connecting to query engine took 0.1876s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0104s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0142s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 39885
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:39885/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:39885/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:39885/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:39885/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:39885/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1876s
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_______________________ test_rate_limiter_redis_blocked ________________________

self = <app.middleware.rate_limit.RateLimiter object at 0x744ba393bd90>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
>               RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                ^^^^^^^^^^^^^^^^^
E               NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:55: NameError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_rate_limiter_redis_blocked():
        limiter = RateLimiter()
        limiter._redis = AsyncMock()
        limiter._script = AsyncMock(return_value=0) # Lua returns 0 for blocked
    
>       allowed = await limiter.check("test_key", 10, 60)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x744ba393bd90>
key = 'test_key', limit = 10, window = 60

    async def check(self, key: str, limit: int, window: int) -> bool:
        """
        Check if request is allowed.
        Returns True if allowed, False if limit exceeded.
        """
        scope = "voice" # Simplify for now, or extract from key
        if "voice" in key:
            scope = "voice"
        else:
            scope = "general"
    
        if self._redis:
            try:
                # Use Lua script for atomicity
                result = await self._script(keys=[key], args=[limit, window])
                allowed = bool(result)
                RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed" if allowed else "blocked").inc()
                if not allowed:
                    RATE_LIMIT_HITS.labels(scope=scope).inc()
                return allowed
            except Exception as e:
                logger.error(f"Redis rate limit error: {e}")
>               REDIS_ERRORS.inc()
                ^^^^^^^^^^^^
E               NameError: name 'REDIS_ERRORS' is not defined

app/middleware/rate_limit.py:61: NameError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0092s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.013s
Running query engine on port 42037
Starting query engine...
Constructed GET request to http://localhost:42037/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:22.034305Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:22.072512Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:42037","ip":"127.0.0.1","port":"42037"},"target":"query_engine::server"}
Constructed GET request to http://localhost:42037/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:42037/status "HTTP/1.1 200 OK"
GET http://localhost:42037/status returned status 200
GET http://localhost:42037/status returned {'status': 'ok'}
Connecting to query engine took 0.1869s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0092s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.013s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 42037
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:42037/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:42037/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:42037/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:42037/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:42037/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1869s
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
__________________________ test_rate_limiter_fallback __________________________

    @pytest.mark.asyncio
    async def test_rate_limiter_fallback():
        limiter = RateLimiter()
        limiter._redis = None # Simulate no redis
    
        # Should use in-memory fallback
        # Limit 2
        key = "test_fallback"
>       assert await limiter.check(key, 2, 60) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_rate_limit.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/middleware/rate_limit.py:65: in check
    return self._check_fallback(key, limit, window, scope)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.middleware.rate_limit.RateLimiter object at 0x744ba0dcdf50>
key = 'test_fallback', limit = 2, window = 60, scope = 'general'

    def _check_fallback(self, key: str, limit: int, window: int, scope: str = "general") -> bool:
        now = int(time.time())
        # Simple fixed window based on time bucket
        bucket = now // window
        full_key = f"{key}:{bucket}"
    
        count = self._fallback_counters.get(full_key, 0)
        if count >= limit:
            RATE_LIMIT_CHECKS.labels(scope=scope, status="blocked").inc()
            RATE_LIMIT_HITS.labels(scope=scope).inc()
            return False
    
        self._fallback_counters[full_key] = count + 1
>       RATE_LIMIT_CHECKS.labels(scope=scope, status="allowed").inc()
        ^^^^^^^^^^^^^^^^^
E       NameError: name 'RATE_LIMIT_CHECKS' is not defined

app/middleware/rate_limit.py:80: NameError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0081s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0164s
Running query engine on port 48613
Starting query engine...
Constructed GET request to http://localhost:48613/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:22.479404Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
{"timestamp":"2026-02-06T20:04:22.522105Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:48613","ip":"127.0.0.1","port":"48613"},"target":"query_engine::server"}
HTTP Request: GET http://localhost:48613/status "HTTP/1.1 200 OK"
GET http://localhost:48613/status returned status 200
GET http://localhost:48613/status returned {'status': 'ok'}
Connecting to query engine took 0.1146s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0081s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0164s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 48613
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:48613/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:48613/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:48613/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:48613/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1146s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______ test_role_change_with_same_dedup_key_returns_422[worker-architect] ______

initial_role = 'worker', changed_role = 'architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba2544290 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba2544290 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0068s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0128s
Running query engine on port 40443
Starting query engine...
Constructed GET request to http://localhost:40443/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:25.634092Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:25.673128Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:40443","ip":"127.0.0.1","port":"40443"},"target":"query_engine::server"}
Constructed GET request to http://localhost:40443/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:40443/status "HTTP/1.1 200 OK"
GET http://localhost:40443/status returned status 200
GET http://localhost:40443/status returned {'status': 'ok'}
Connecting to query engine took 0.2116s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0068s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0128s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 40443
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40443/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40443/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:40443/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:40443/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:40443/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.2116s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:40443/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba2544290 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:40443/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba2544290 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______ test_role_change_with_same_dedup_key_returns_422[Worker-architect] ______

initial_role = 'Worker', changed_role = 'architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba154ed90 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba154ed90 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0068s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0128s
Running query engine on port 59631
Starting query engine...
Constructed GET request to http://localhost:59631/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:30.156394Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:30.188655Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:59631","ip":"127.0.0.1","port":"59631"},"target":"query_engine::server"}
Constructed GET request to http://localhost:59631/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:59631/status "HTTP/1.1 200 OK"
GET http://localhost:59631/status returned status 200
GET http://localhost:59631/status returned {'status': 'ok'}
Connecting to query engine took 0.2003s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0068s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0128s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 59631
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:59631/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:59631/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:59631/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:59631/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:59631/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.2003s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:59631/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba154ed90 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:59631/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba154ed90 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
______ test_role_change_with_same_dedup_key_returns_422[worker-Architect] ______

initial_role = 'worker', changed_role = 'Architect'

    @pytest.mark.parametrize("initial_role,changed_role", [
        ("worker", "architect"),
        ("Worker", "architect"),
        ("worker", "Architect"),
    ])
    def test_role_change_with_same_dedup_key_returns_422(initial_role, changed_role):
        client = TestClient(app)
        base = {
            "name": "RoleTest",
            "role": initial_role,
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RR"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba226e110 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba226e110 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0206s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.027s
Running query engine on port 49533
Starting query engine...
Constructed GET request to http://localhost:49533/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:34.721707Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:34.752484Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:49533","ip":"127.0.0.1","port":"49533"},"target":"query_engine::server"}
Constructed GET request to http://localhost:49533/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:49533/status "HTTP/1.1 200 OK"
GET http://localhost:49533/status returned status 200
GET http://localhost:49533/status returned {'status': 'ok'}
Connecting to query engine took 0.2216s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0206s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.027s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 49533
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49533/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:49533/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:49533/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:49533/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:49533/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.2216s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:49533/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba226e110 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RR"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:49533/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RR\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba226e110 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
____________________ test_case_only_role_is_considered_same ____________________

    def test_case_only_role_is_considered_same():
        client = TestClient(app)
        base = {
            "name": "RoleCase",
            "role": "Worker",
            "version": "0.1.0",
            "capabilities": [],
            "topics": [],
            "health_url": None,
            "dedup_key": "00000000-0000-0000-0000-00000000RC"
        }
>       r1 = client.post("/agents/register", json=base)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_role_immutability.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1146: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:828: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:915: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:943: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:980: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1016: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py:810: in __call__
    await self.app(scope, otel_receive, otel_send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py:307: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py:87: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:169: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py:167: in __call__
    await self.app(scope, receive, send_wrapper)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:432: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:320: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/routers/agents.py:72: in register_agent
    data, no_change = await agent_registry.register_agent(request)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/agent_registry.py:76: in register_agent
    existing_agent = await db.agent.find_first(where={"dedupKey": request.dedup_key})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/actions.py:4658: in find_first
    resp = await self._client._execute(
/usr/local/lib/python3.11/site-packages/prisma/_base_client.py:543: in _execute
    return await self._engine.query(builder.build(), tx_id=self._tx_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/engine/_query.py:402: in query
    return await self.request(
/usr/local/lib/python3.11/site-packages/prisma/engine/_http.py:217: in request
    response = await self.session.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/prisma/_async_http.py:26: in request
    return Response(await self.session.request(method, url, **kwargs))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_transports/default.py:371: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
/usr/local/lib/python3.11/site-packages/httpcore/_async/connection.py:103: in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:136: in handle_async_request
    raise exc
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:106: in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:177: in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpcore/_async/http11.py:217: in _receive_event
    data = await self._network_stream.read(
/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py:35: in read
    return await self._stream.receive(max_bytes=max_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:1269: in receive
    await self._protocol.read_event.wait()
/usr/local/lib/python3.11/asyncio/locks.py:210: in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.locks.Event object at 0x744ba0426190 [unset]>

    def _get_loop(self):
        loop = events._get_running_loop()
    
        if self._loop is None:
            with _global_lock:
                if self._loop is None:
                    self._loop = loop
        if loop is not self._loop:
>           raise RuntimeError(f'{self!r} is bound to a different event loop')
E           RuntimeError: <asyncio.locks.Event object at 0x744ba0426190 [unset]> is bound to a different event loop

/usr/local/lib/python3.11/asyncio/mixins.py:20: RuntimeError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.01s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0137s
Running query engine on port 53423
Starting query engine...
Constructed GET request to http://localhost:53423/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:39.597319Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:39.635405Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:53423","ip":"127.0.0.1","port":"53423"},"target":"query_engine::server"}
Constructed GET request to http://localhost:53423/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:53423/status "HTTP/1.1 200 OK"
GET http://localhost:53423/status returned status 200
GET http://localhost:53423/status returned {'status': 'ok'}
Connecting to query engine took 0.1898s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.01s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0137s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 53423
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53423/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:53423/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:53423/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:53423/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:53423/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1898s
----------------------------- Captured stdout call -----------------------------
Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
Constructed POST request to http://localhost:53423/
Request headers: {'Accept': 'application/json'}
Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
Register agent failed: <asyncio.locks.Event object at 0x744ba0426190 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
DEBUG    prisma._builder:_builder.py:189 Generated query: 
query {
  result: findFirstAgent
  (
    where: {
      dedupKey: "00000000-0000-0000-0000-00000000RC"
    }
  )
  {
    id
    name
    role
    version
    capabilities
    topics
    healthUrl
    status
    lastHeartbeat
    createdAt
    updatedAt
    dedupKey
  }
}
DEBUG    prisma.engine._http:_http.py:66 Constructed POST request to http://localhost:53423/
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: {"variables": {}, "operation_name": "query", "query": "query {\n  result: findFirstAgent\n  (\n    where: {\n      dedupKey: \"00000000-0000-0000-0000-00000000RC\"\n    }\n  )\n  {\n    id\n    name\n    role\n    version\n    capabilities\n    topics\n    healthUrl\n    status\n    lastHeartbeat\n    createdAt\n    updatedAt\n    dedupKey\n  }\n}"}
ERROR    app.services.agent_registry:agent_registry.py:158 Register agent failed: <asyncio.locks.Event object at 0x744ba0426190 [unset]> is bound to a different event loop
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_______________________ test_sse_handles_cancelled_error _______________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_sse_resilience.py", line 24, in test_sse_handles_cancelled_error
  |     resp = client.get("/agents/stream")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x744ba0da86d0 [unset]> is bound to a different event loop
    +------------------------------------
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0097s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0135s
Running query engine on port 45833
Starting query engine...
Constructed GET request to http://localhost:45833/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:45.436737Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:45.467418Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:45833","ip":"127.0.0.1","port":"45833"},"target":"query_engine::server"}
Constructed GET request to http://localhost:45833/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:45833/status "HTTP/1.1 200 OK"
GET http://localhost:45833/status returned status 200
GET http://localhost:45833/status returned {'status': 'ok'}
Connecting to query engine took 0.1831s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0097s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0135s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 45833
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:45833/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:45833/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:45833/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:45833/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:45833/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1831s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
_____________________ test_sse_pubsub_failure_does_not_500 _____________________
  + Exception Group Traceback (most recent call last):
  |   File "/app/tests/unit/test_sse_resilience.py", line 48, in test_sse_pubsub_failure_does_not_500
  |     resp = client.get("/agents/watch")
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 473, in get
  |     return super().get(
  |            ^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1055, in get
  |     return self.request(
  |            ^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 445, in request
  |     return super().request(
  |            ^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 828, in request
  |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 915, in send
  |     response = self._send_handling_auth(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 943, in _send_handling_auth
  |     response = self._send_handling_redirects(
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 980, in _send_handling_redirects
  |     response = self._send_single_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/httpx/_client.py", line 1016, in _send_single_request
  |     response = transport.handle_request(request)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 348, in handle_request
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/testclient.py", line 345, in handle_request
  |     portal.call(self.app, scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 334, in call
  |     return cast(T_Retval, self.start_task_soon(func, *args).result())
  |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 456, in result
  |     return self.__get_result()
  |            ^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
  |     raise self._exception
  |   File "/usr/local/lib/python3.11/site-packages/anyio/from_thread.py", line 259, in _call_func
  |     retval = await retval_or_awaitable
  |              ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
  |     await super().__call__(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/asgi/__init__.py", line 810, in __call__
  |     await self.app(scope, otel_receive, otel_send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
  |     await self.app(scope, receive, _send)
  |   File "/usr/local/lib/python3.11/site-packages/opentelemetry/instrumentation/fastapi/__init__.py", line 307, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 87, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 169, in __call__
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 167, in __call__
  |     await self.app(scope, receive, send_wrapper)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
  |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
  |     await self.middleware_stack(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
  |     await route.handle(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
  |     await self.app(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 124, in app
  |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
  |     raise exc
  |   File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
  |     await app(scope, receive, sender)
  |   File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
  |     await response(scope, receive, send)
  |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 237, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 240, in wrap
    |     await func()
    |   File "/usr/local/lib/python3.11/site-packages/sse_starlette/sse.py", line 215, in listen_for_exit_signal
    |     await AppStatus.should_exit_event.wait()
    |   File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1789, in wait
    |     await self._event.wait()
    |   File "/usr/local/lib/python3.11/asyncio/locks.py", line 210, in wait
    |     fut = self._get_loop().create_future()
    |           ^^^^^^^^^^^^^^^^
    |   File "/usr/local/lib/python3.11/asyncio/mixins.py", line 20, in _get_loop
    |     raise RuntimeError(f'{self!r} is bound to a different event loop')
    | RuntimeError: <asyncio.locks.Event object at 0x744ba0da86d0 [unset]> is bound to a different event loop
    +------------------------------------
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0065s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0126s
Running query engine on port 40753
Starting query engine...
Constructed GET request to http://localhost:40753/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:45.736888Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:45.770410Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:40753","ip":"127.0.0.1","port":"40753"},"target":"query_engine::server"}
Constructed GET request to http://localhost:40753/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:40753/status "HTTP/1.1 200 OK"
GET http://localhost:40753/status returned status 200
GET http://localhost:40753/status returned {'status': 'ok'}
Connecting to query engine took 0.1851s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0065s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0126s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 40753
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40753/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:40753/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:40753/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:40753/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:40753/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1851s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
____________________ test_sse_stream_connects_with_backoff _____________________

async_client = <httpx.AsyncClient object at 0x744ba3ae2890>

    @pytest.mark.asyncio
    async def test_sse_stream_connects_with_backoff(async_client):
        connected = False
        for delay in _backoff_delays():
            try:
                async with async_client.stream("GET", "/agents/watch?one_shot=true", timeout=Timeout(2.0)) as resp:
                    if resp.status_code == 200:
                        connected = True
                        break
            except Exception:
                await asyncio.sleep(delay)
>       assert connected
E       assert False

tests/unit/test_sse_stability.py:23: AssertionError
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0064s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0121s
Running query engine on port 57819
Starting query engine...
Constructed GET request to http://localhost:57819/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:46.031111Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:46.063800Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:57819","ip":"127.0.0.1","port":"57819"},"target":"query_engine::server"}
Constructed GET request to http://localhost:57819/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:57819/status "HTTP/1.1 200 OK"
GET http://localhost:57819/status returned status 200
GET http://localhost:57819/status returned {'status': 'ok'}
Connecting to query engine took 0.1825s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0064s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0121s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 57819
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:57819/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:57819/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:57819/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:57819/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:57819/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1825s
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
__________________ test_voice_ws_text_flow_dev_auth_disabled ___________________

    def test_voice_ws_text_flow_dev_auth_disabled():
        settings = get_settings()
        # ensure dev mode allows open access
        assert settings.API_KEY in (None, "",)
        with client.websocket_connect("/voice/ws") as ws:
            ws.send_text(json.dumps({"text": "print('hi')"}))
>           data = ws.receive_json()
                   ^^^^^^^^^^^^^^^^^

tests/unit/test_voice_ws.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:191: in receive_json
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.testclient.WebSocketTestSession object at 0x744ba13466d0>
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.11/site-packages/starlette/testclient.py:144: WebSocketDisconnect
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0065s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0106s
Running query engine on port 60323
Starting query engine...
Constructed GET request to http://localhost:60323/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:58.178049Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:58.208634Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:60323","ip":"127.0.0.1","port":"60323"},"target":"query_engine::server"}
Constructed GET request to http://localhost:60323/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:60323/status "HTTP/1.1 200 OK"
GET http://localhost:60323/status returned status 200
GET http://localhost:60323/status returned {'status': 'ok'}
Connecting to query engine took 0.1842s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0065s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0106s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 60323
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:60323/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:60323/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:60323/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:60323/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:60323/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.1842s
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
[2m2026-02-06T20:04:58.470658Z[0m [[31m[1merror    [0m] [1mvoice_ws_error                [0m [36merror[0m=[35mname 'REDIS_ERRORS' is not defined[0m
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: name 'RATE_LIMIT_CHECKS' is not defined
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
___________________________ test_voice_ws_rate_limit ___________________________

    def test_voice_ws_rate_limit():
        # simulate many messages and expect success under limit
        with client.websocket_connect("/voice/ws") as ws:
            for _ in range(5):
                ws.send_text(json.dumps({"text": "print('x')"}))
>               data = ws.receive_json()
                       ^^^^^^^^^^^^^^^^^

tests/unit/test_voice_ws.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:191: in receive_json
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.testclient.WebSocketTestSession object at 0x744ba2516910>
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.11/site-packages/starlette/testclient.py:144: WebSocketDisconnect
---------------------------- Captured stdout setup -----------------------------
datasources: None
Connecting to query engine
Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Version check took 0.0093s
Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
Ensuring query engine took: 0.0126s
Running query engine on port 44561
Starting query engine...
Constructed GET request to http://localhost:44561/status
Request headers: {'Accept': 'application/json'}
Request content: None
{"timestamp":"2026-02-06T20:04:58.832026Z","level":"INFO","fields":{"message":"Starting a postgresql pool with 5 connections."},"target":"quaint::pooled"}
Could not connect to query engine due to All connection attempts failed; retrying...
{"timestamp":"2026-02-06T20:04:58.862660Z","level":"INFO","fields":{"message":"Started query engine http server on http://127.0.0.1:44561","ip":"127.0.0.1","port":"44561"},"target":"query_engine::server"}
Constructed GET request to http://localhost:44561/status
Request headers: {'Accept': 'application/json'}
Request content: None
HTTP Request: GET http://localhost:44561/status "HTTP/1.1 200 OK"
GET http://localhost:44561/status returned status 200
GET http://localhost:44561/status returned {'status': 'ok'}
Connecting to query engine took 0.186s
------------------------------ Captured log setup ------------------------------
DEBUG    prisma._base_client:_base_client.py:286 datasources: None
DEBUG    prisma.engine._query:_query.py:339 Connecting to query engine
DEBUG    prisma.engine.utils:utils.py:78 Expecting local query engine /app/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:79 Expecting global query engine /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/prisma-query-engine-debian-openssl-3.5.x
DEBUG    prisma.engine.utils:utils.py:97 Query engine found from the Prisma CLI generated path: /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:115 Using Query Engine binary at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:119 Version check took 0.0093s
DEBUG    prisma.engine.utils:utils.py:122 Using query engine version 393aa359c9ad4a4bb28630fb5613f9c281cde053
DEBUG    prisma.engine.utils:utils.py:127 Using query engine at /home/appuser/.cache/prisma-python/binaries/5.17.0/393aa359c9ad4a4bb28630fb5613f9c281cde053/node_modules/prisma/query-engine-debian-openssl-3.0.x
DEBUG    prisma.engine.utils:utils.py:128 Ensuring query engine took: 0.0126s
DEBUG    prisma.engine._query:_query.py:67 Running query engine on port 44561
DEBUG    prisma.engine._query:_query.py:101 Starting query engine...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:44561/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
DEBUG    prisma.engine._query:_query.py:375 Could not connect to query engine due to All connection attempts failed; retrying...
DEBUG    prisma.engine._http:_http.py:66 Constructed GET request to http://localhost:44561/status
DEBUG    prisma.engine._http:_http.py:67 Request headers: {'Accept': 'application/json'}
DEBUG    prisma.engine._http:_http.py:68 Request content: None
INFO     httpx:_client.py:1758 HTTP Request: GET http://localhost:44561/status "HTTP/1.1 200 OK"
DEBUG    prisma.engine._http:_http.py:218 GET http://localhost:44561/status returned status 200
DEBUG    prisma.engine._http:_http.py:231 GET http://localhost:44561/status returned {'status': 'ok'}
DEBUG    prisma.engine._query:_query.py:355 Connecting to query engine took 0.186s
----------------------------- Captured stdout call -----------------------------
Redis rate limit error: Event loop is closed
[2m2026-02-06T20:04:59.043963Z[0m [[31m[1merror    [0m] [1mvoice_ws_error                [0m [36merror[0m=[35mname 'REDIS_ERRORS' is not defined[0m
------------------------------ Captured log call -------------------------------
ERROR    app.middleware.rate_limit:rate_limit.py:60 Redis rate limit error: Event loop is closed
--------------------------- Captured stdout teardown ---------------------------
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
Disconnecting query engine...
Disconnected query engine
---------------------------- Captured log teardown -----------------------------
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
DEBUG    prisma.engine._query:_query.py:322 Disconnecting query engine...
DEBUG    prisma.engine._query:_query.py:326 Disconnected query engine
=============================== warnings summary ===============================
app/core/config.py:5
  /app/app/core/config.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

app/schemas/agent.py:17
  /app/app/schemas/agent.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AgentMetadata(BaseModel):

app/schemas/memory.py:24
  /app/app/schemas/memory.py:24: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class MemoryResponse(MemoryBase):

tests/unit/test_services_event_bus.py::test_publish_subscribe_envelope_roundtrip
  /app/app/services/event_bus.py:185: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await pubsub.close()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.11.14-final-0 ----------
Name                                Stmts   Miss Branch BrPart  Cover   Missing
-------------------------------------------------------------------------------
app/core/auth.py                       39     28     20      0    19%   15-35, 48-92
app/core/config.py                     39      6     10      2    76%   27-31, 45->50, 48-49
app/core/db.py                        254    250    144      0     1%   6-298
app/core/event_bus.py                  22      0      4      1    96%   29->exit
app/core/logging.py                    12      1      2      1    86%   21
app/engine/adapter.py                  57     11      8      0    83%   48-51, 65-69, 71-72
app/engine/cli.py                      35      7      8      3    72%   9, 24-25, 31-34, 38->exit
app/engine/interpreter.py             231     52    156     22    73%   70, 76-77, 109->107, 125, 133-134, 136, 142, 143->145, 149, 153, 159-169, 179, 189-190, 196, 212-217, 222, 225-227, 238, 241-248, 256, 265, 268-274
app/errors/nd_errors.py                82      4     40      8    90%   30->33, 34, 35->37, 50, 104->exit, 149->152, 153, 155
app/middleware/rate_limit.py           58     13     12      1    74%   35-37, 56-58, 63, 75-77, 83-86
app/parser/__init__.py                  1      0      0      0   100%
app/parser/hc_parser.py               314     26    160     19    88%   69-71, 101-102, 123->125, 146->148, 153, 161->159, 168, 179-180, 189->187, 233->238, 243, 249, 301-307, 316, 322-324, 333, 335, 339, 363
app/routers/agents.py                 120     45     44      6    63%   31->21, 32->31, 42-53, 55-56, 61, 83, 88-89, 103-108, 112-124, 130, 135-142
app/routers/engine.py                  24      2      4      1    89%   21-22
app/routers/execution.py               39      8     16      1    76%   19, 45-46, 49-50, 54-56
app/routers/memory.py                  34     17     18      0    56%   10, 21-29, 33-36, 40-43, 47-50, 54-55
app/routers/metrics.py                 81     35     26      0    54%   17-28, 41-55, 88-97, 115-116
app/routers/orchestrator.py            83     28     50      5    68%   12, 17-20, 31, 37, 52, 59, 64-67, 71-72, 78, 83-86, 90-93, 97-100
app/routers/simulator.py               44     28     14      0    38%   15-30, 35, 40-51, 56-64
app/routers/voice.py                   83     51     20      2    35%   35, 43-107, 109, 115-116
app/schemas/agent.py                   38      0      4      0   100%
app/schemas/execution.py               21      0      0      0   100%
app/schemas/memory.py                  32      0      0      0   100%
app/schemas/message.py                 12      0      4      0   100%
app/schemas/mission.py                 26      0      0      0   100%
app/services/__init__.py                0      0      0      0   100%
app/services/agent_registry.py        155     29     32      6    79%   78, 85-86, 106-107, 112, 176, 183-184, 187-190, 209, 230-232, 245-253, 270, 280-281
app/services/event_bus.py             127     39     34     10    66%   45-51, 59-61, 73-75, 83-84, 98-100, 103-108, 111-114, 122->124, 127-128, 137->139, 141-142, 148-149, 157-158, 165->184, 170, 176-177, 181-182
app/services/execution_service.py      78     24     22      6    70%   37-43, 66-79, 98, 104, 105->107, 108, 111->113, 115
app/services/key_manager.py            71      1     16      3    95%   61->65, 97, 99->95
app/services/llm.py                    35     35      2      0     0%   2-77
app/services/llm_service.py            54     37     16      0    24%   27-41, 45-64, 68, 72-95
app/services/memory_service.py        156     94     54      3    40%   13-18, 34, 37-39, 48-50, 56-67, 93-94, 99-108, 112-145, 149-158, 162-195
app/services/metrics_registry.py       37      4     14      1    82%   23-24, 29->32, 35-36
app/services/orchestrator.py          276    117     57     12    56%   50-55, 88, 109-110, 133->140, 137-138, 141->148, 145-146, 153-155, 158->exit, 161-179, 185, 189-190, 193-290, 297, 307->320, 314-317, 374-379, 390-411, 433-440, 443-464, 503, 508-510
app/services/voice_service.py         110     38     38      3    64%   53, 65, 80, 95-109, 114, 132-133, 135-139, 143-151, 155-160
main.py                               260    190     58      3    26%   7-9, 38-42, 51-52, 70->75, 76-77, 87-296, 306-311, 330-356
-------------------------------------------------------------------------------
TOTAL                                3140   1220   1107    119    59%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/e2e/test_integration_bridge.py::test_agent_registration_e2e - Ru...
FAILED tests/e2e/test_integration_bridge.py::test_mission_submission_e2e - Ru...
FAILED tests/unit/test_agent_registry_acceptance.py::test_duplicate_payload_returns_200
FAILED tests/unit/test_agent_registry_acceptance.py::test_immutable_role_change_rejected_422
FAILED tests/unit/test_agent_registry_acceptance.py::test_version_minor_bumps_and_patch_resets_on_dedup_re_register
FAILED tests/unit/test_agents.py::test_sse_stream_endpoint_sync - RuntimeErro...
FAILED tests/unit/test_auth_config.py::test_security_validation_prod_short - ...
FAILED tests/unit/test_auth_config.py::test_security_validation_prod_valid - ...
FAILED tests/unit/test_collaboration_efficiency.py::test_agents_collaboration_register_list_heartbeat
FAILED tests/unit/test_error_handling.py::test_agent_register_role_change_422
FAILED tests/unit/test_execute_hc_file.py::test_execute_hc_file_run - assert ...
FAILED tests/unit/test_immutable_error_payload.py::test_immutable_role_error_payload
FAILED tests/unit/test_memory_service.py::test_memory_crud_and_search - prism...
FAILED tests/unit/test_mission_flow_report.py::test_mission_flow_and_report
FAILED tests/unit/test_mission_lifecycle.py::test_mission_full_lifecycle - Ru...
FAILED tests/unit/test_orchestrator_selection.py::test_orchestrator_assign_prefers_capability_and_health
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_redis_allowed - NameE...
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_redis_blocked - NameE...
FAILED tests/unit/test_rate_limit.py::test_rate_limiter_fallback - NameError:...
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-architect]
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[Worker-architect]
FAILED tests/unit/test_role_immutability.py::test_role_change_with_same_dedup_key_returns_422[worker-Architect]
FAILED tests/unit/test_role_immutability.py::test_case_only_role_is_considered_same
FAILED tests/unit/test_sse_resilience.py::test_sse_handles_cancelled_error - ...
FAILED tests/unit/test_sse_resilience.py::test_sse_pubsub_failure_does_not_500
FAILED tests/unit/test_sse_stability.py::test_sse_stream_connects_with_backoff
FAILED tests/unit/test_voice_ws.py::test_voice_ws_text_flow_dev_auth_disabled
FAILED tests/unit/test_voice_ws.py::test_voice_ws_rate_limit - starlette.webs...
============ 28 failed, 63 passed, 4 warnings in 140.40s (0:02:20) =============
